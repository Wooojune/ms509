<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>用IRC协议与PHP木马“聊天” | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">用IRC协议与PHP木马“聊天”</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/contact/"><i class="fa fa-comments"> 联系</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">用IRC协议与PHP木马“聊天”</h1><div class="post-meta">2016-08-19<span> | </span><span class="category"><a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 6.6k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 37</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>作者：expsky</p>
<p>最近，我们的网络监测设备中发现了revslider.zip文件，解压后的两个php文件mil.php，pbot.php都经过了编码处理，非常可疑。搜索revslider关键字能找到freebuf上的一篇文章<a href="http://www.freebuf.com/news/62328.html" target="_blank" rel="noopener">《RevSlider插件漏洞导致大量WordPress网站被黑》</a>，进一步确认了猜测，于是对这两个php文件进行了分析。<a id="more"></a></p>
<p><a href="http://www.ms509.com/?attachment_id=423" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/1.jpg" alt="1"></a></p>
<h3 id="一、pbot-php"><a href="#一、pbot-php" class="headerlink" title="一、pbot.php"></a><strong>一、pbot.php</strong></h3><p>通常的webshell木马，顾名思义就是操作界面是web网页，通过http协议进行通讯，能远程执行shell命令。而该木马利用的是IRC协议进行通讯，操作界面是IRC聊天客户端软件，除了同样能够执行shell命令外，还能接收其他更多的远程控制命令（后面会看到）。</p>
<h4 id="什么是IRC木马？"><a href="#什么是IRC木马？" class="headerlink" title="什么是IRC木马？"></a><strong>什么是IRC木马？</strong></h4><p>IRC是Internet Relay Chat的英文缩写，是应用层的即时通讯协议。特点是小而美，原理非常简单，用户运行基于IRC协议的客户端软件，连接上IRC服务器，就可以开始聊天了。与传统的webshell比，IRC木马远控的过程就是和肉鸡“聊天”的过程，有更多优势：</p>
<pre class="lang:default decode:true">可以使用任意的IRC聊天软件来进行远程控制，操作界面更加友好

木马功能更加强大，除了执行shell命令外，可以执行更多的远控命令，而且扩展起来方便，易于维护

在一个聊天窗口，同时控制多台肉鸡（与多个肉鸡“聊天”）</pre>
<p>如下是两个常见的IRC聊天软件：mIRC, XChat</p>
<p><a href="http://www.ms509.com/?attachment_id=425" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/mirc.jpg" alt="mirc"></a> <a href="http://www.ms509.com/?attachment_id=426" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/xchat.jpg" alt="xchat"></a></p>
<p>这个IRC php木马实现了基本的IRC通讯协议，木马运行后连接到了irc.mildnet.net这台IRC服务器，并进入预先设置好的私有频道（群），身在某个角落的木马作者用任意IRC客户端软件加入到相同的频道（群）。可以想象成这样一个画面，一个聊天群里有很多成员，除了木马作者外，其他成员都是被控制的肉鸡，作者可以@任何肉鸡，与它聊天，聊天的内容就是提前设置的远控命令，告诉肉鸡要做什么，肉鸡完成任务后再给作者回复结果。</p>
<h4 id="IRC协议简介"><a href="#IRC协议简介" class="headerlink" title="IRC协议简介"></a><strong>IRC协议简介</strong></h4><p>IRC详细的协议比较多，这里介绍下最主要的</p>
<p>客户端与服务器之间通讯传递的是一条条的IRC消息，IRC消息是纯文本格式，一条IRC消息最长不超过512字节，以\r\n标志结束</p>
<p>一条IRC消息由三个部分组成，<strong>前缀、命令字、参数，</strong>以空格分开，其中前缀和参数不是必须的部分，命令字是IRC协议的核心，一共有几十个命令字。命令字有两种表示类型，一种是大写的带英文含义的字符串（如NICK），一种是纯数字（如433）</p>
<table><colgroup> <col width="NaN%"> <col width="NaN%"> <col width="NaN%"> <col width="NaN%"></colgroup>
<thead>
<tr>
<th>前缀</th>
<th>命令</th>
<th>参数</th>
<th>结尾符</th>
</tr>
</thead>
<tbody>
<tr>
<td>: xxx!name@freebuf.com</td>
<td>NICK</td>
<td>expsky</td>
<td>\r\n</td>
</tr>
</tbody>
</table>
上面是一条IRC消息，应该能猜出意思就是，告诉服务器我把自己的昵称修改为了expsky

<p>IRC全部英文命令字：</p>
<pre><code>ADMIN，AWAY，CNOTICE，CPRIVMSG，CONNECT，DIE，ENCAP，ERROR，&lt;span class=&quot;hljs-keyword&quot;&gt;HELP&lt;/span&gt;，INFO，INVITE，ISON，&lt;span class=&quot;hljs-keyword&quot;&gt;JOIN&lt;/span&gt;，KICK，&lt;span class=&quot;hljs-keyword&quot;&gt;KILL&lt;/span&gt;，KNOCK，LINKS，&lt;span class=&quot;hljs-keyword&quot;&gt;LIST&lt;/span&gt;，LUSERS，&lt;span class=&quot;hljs-keyword&quot;&gt;MODE&lt;/span&gt;，MOTD，&lt;span class=&quot;hljs-keyword&quot;&gt;NAMES&lt;/span&gt;，NAMESX，NICK，&lt;span class=&quot;hljs-keyword&quot;&gt;NOTICE&lt;/span&gt;，OPER，PART，PASS，PING，PONG，PRIVMSG，QUIT，REHASH，RESTART，&lt;span class=&quot;hljs-keyword&quot;&gt;RULES&lt;/span&gt;，&lt;span class=&quot;hljs-keyword&quot;&gt;SERVER&lt;/span&gt;，SERVICE，SERVLIST，SQUERY，SQUIT，SETNAME，SILENCE，STATS，SUMMON，&lt;span class=&quot;hljs-keyword&quot;&gt;TIME&lt;/span&gt;，TOPIC，&lt;span class=&quot;hljs-keyword&quot;&gt;TRACE&lt;/span&gt;，UHNAMES，&lt;span class=&quot;hljs-keyword&quot;&gt;USER&lt;/span&gt;，USERHOST，USERIP，&lt;span class=&quot;hljs-keyword&quot;&gt;USERS&lt;/span&gt;，&lt;span class=&quot;hljs-keyword&quot;&gt;VERSION&lt;/span&gt;，WALLOPS，WATCH，WHO，WHOIS，WHOWAS
`&lt;/pre&gt;
IRC全部数字命令字：
&lt;pre&gt;`&lt;span class=&quot;hljs-string&quot;&gt;&quot;001&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;welcome&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;002&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;yourhost&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;003&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;created&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;004&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;myinfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;005&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;featurelist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;200&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tracelink&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;201&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceconnecting&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;202&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tracehandshake&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;203&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceunknown&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;204&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceoperator&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;205&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceuser&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;206&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceserver&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;207&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceservice&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;208&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tracenewtype&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;209&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;traceclass&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;210&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tracereconnect&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;211&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statslinkinfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;212&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statscommands&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;213&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statscline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;214&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsnline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;215&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsiline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;216&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statskline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;217&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsqline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;218&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsyline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;219&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofstats&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;221&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;umodeis&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;231&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;serviceinfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;232&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofservices&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;233&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;service&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;234&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;servlist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;235&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;servlistend&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;241&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statslline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;242&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsuptime&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;243&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statsoline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;244&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;statshline&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;250&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserconns&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;251&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserclient&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;252&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserop&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;253&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserunknown&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;254&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserchannels&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;255&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;luserme&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;256&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;adminme&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;257&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;adminloc1&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;258&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;adminloc2&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;259&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;adminemail&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;261&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tracelog&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;262&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endoftrace&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;263&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;tryagain&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;265&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;n_local&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;266&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;n_global&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;300&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;none&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;301&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;away&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;302&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;userhost&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;303&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;ison&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;305&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;unaway&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;306&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nowaway&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;311&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoisuser&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;312&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoisserver&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;313&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoisoperator&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;314&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whowasuser&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;315&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofwho&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;316&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoischanop&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;317&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoisidle&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;318&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofwhois&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;319&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoischannels&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;321&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;liststart&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;322&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;list&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;323&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;listend&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;324&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;channelmodeis&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;329&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;channelcreate&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;331&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;notopic&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;332&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;currenttopic&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;333&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;topicinfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;341&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;inviting&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;342&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;summoning&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;346&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;invitelist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;347&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofinvitelist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;348&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;exceptlist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;349&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofexceptlist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;351&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;version&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;352&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;whoreply&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;353&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;namreply&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;361&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;killdone&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;362&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;closing&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;363&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;closeend&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;364&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;links&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;365&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endoflinks&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;366&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofnames&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;367&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;banlist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;368&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofbanlist&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;369&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofwhowas&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;371&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;info&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;372&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;motd&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;373&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;infostart&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;374&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofinfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;375&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;motdstart&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;376&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofmotd&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;377&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;motd2&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;381&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;youreoper&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;382&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;rehashing&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;384&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;myportis&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;391&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;time&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;392&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;usersstart&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;393&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;users&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;394&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;endofusers&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;395&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nousers&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;401&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nosuchnick&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;402&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nosuchserver&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;403&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nosuchchannel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;404&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;cannotsendtochan&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;405&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;toomanychannels&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;406&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;wasnosuchnick&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;407&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;toomanytargets&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;409&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;noorigin&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;411&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;norecipient&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;412&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;notexttosend&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;413&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;notoplevel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;414&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;wildtoplevel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;421&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;unknowncommand&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;422&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nomotd&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;423&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;noadmininfo&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;424&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;fileerror&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;431&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nonicknamegiven&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;432&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;erroneusnickname&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;433&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nicknameinuse&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;436&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nickcollision&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;437&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;unavailresource&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;441&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;usernotinchannel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;442&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;notonchannel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;443&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;useronchannel&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;444&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nologin&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;445&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;summondisabled&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;446&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;usersdisabled&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;451&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;notregistered&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;461&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;needmoreparams&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;462&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;alreadyregistered&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;463&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nopermforhost&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;464&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;passwdmismatch&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;465&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;yourebannedcreep&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;466&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;youwillbebanned&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;467&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;keyset&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;471&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;channelisfull&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;472&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;unknownmode&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;473&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;inviteonlychan&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;474&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;bannedfromchan&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;475&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;badchannelkey&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;476&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;badchanmask&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;477&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nochanmodes&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;478&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;banlistfull&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;481&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;noprivileges&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;482&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;chanoprivsneeded&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;483&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;cantkillserver&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;484&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;restricted&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;485&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;uniqopprivsneeded&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;491&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;nooperhost&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;492&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;noservicehost&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;501&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;umodeunknownflag&quot;&lt;/span&gt;,    &lt;span class=&quot;hljs-string&quot;&gt;&quot;502&quot;&lt;/span&gt;: &lt;span class=&quot;hljs-string&quot;&gt;&quot;usersdontmatch&quot;&lt;/span&gt;,
`&lt;/pre&gt;
IRC命令解释详见：[List of Internet Relay Chat commands](https://en.wikipedia.org/wiki/List_of_Internet_Relay_Chat_commands)

#### **pbot.php木马利用IRC协议进行通讯过程**

分析前先对编码过的php代码进行解码

![2](http://www.ms509.com/wp-content/uploads/2016/08/2.jpg)

此木马用到的IRC命令字：
&lt;pre class=&quot;lang:default decode:true&quot;&gt;PASS：设置IRC连接密码

USER：设置username,，hostname，realname

NICK：设置昵称

PING：验证客户端是否存活

MODE：设置IRC连接模式

JOIN：加入频道（频道就类似群的概念）

PRIVMSG：发送私有消息（最常用的IRC命令）

001：成功建立IRC连接后服务器返回的welcome消息 

443：昵称重复&lt;/pre&gt;

##### **1）建立IRC连接**
[![3](http://www.ms509.com/wp-content/uploads/2016/08/3.jpg)](http://www.ms509.com/?attachment_id=427)

如上，木马实现IRC协议规定的建立连接握手流程：以PASS，USER，NICK三个IRC命令开始（设置连接密码，用户ID，昵称等信息）
[![4](http://www.ms509.com/wp-content/uploads/2016/08/4.jpg)](http://www.ms509.com/?attachment_id=428)

建立完连接后进入主功能函数main

##### **2）main函数（消息循环）**

IRC连接建立成功后设置连接模式为私有隐藏，加入预先建好的两个远控频道（配置变量中的chan和chan2：即#ccpower和#sianta），频道密码是配置变量里的key即correct

配置参数包含服务器域名，端口，频道名（群名），频道密码，频道模式等信息
&lt;pre&gt;`    &lt;span class=&quot;hljs-keyword&quot;&gt;var&lt;/span&gt; $config = &lt;span class=&quot;hljs-keyword&quot;&gt;array&lt;/span&gt;(&lt;span class=&quot;hljs-string&quot;&gt;&quot;server&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;irc.mildnet.net&quot;&lt;/span&gt;, 
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;port&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;7000&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;pass&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;prefix&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;pbot&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;maxrand&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;2&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;chan&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;#ccpower&quot;&lt;/span&gt;, 
        &lt;span class=&quot;hljs-string&quot;&gt;&quot;chan2&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;#siantar&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;key&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;correct&quot;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&quot;modes&quot;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;hljs-string&quot;&gt;&quot;+ps&quot;&lt;/span&gt;);</code></pre><p><a href="http://www.ms509.com/?attachment_id=429" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/5.jpg" alt="5"></a></p>
<p>调用到的函数（相应IRC协议中的命令JOIN, PRIVMSG, NICK）</p>
<div>
<div>[![join](http://www.ms509.com/wp-content/uploads/2016/08/join.png)](http://www.ms509.com/?attachment_id=507)</div>
</div>

<h4 id="木马自己的远控命令"><a href="#木马自己的远控命令" class="headerlink" title="木马自己的远控命令"></a><strong>木马自己的远控命令</strong></h4><p>上面主要是IRC协议相关的内容，而木马自己的功能，也就是执行各种远程控制命令的代码如下：</p>
<p>（远控命令的发送是通过PRIVMSG IRC命令字发送给木马，以!号开头）</p>
<p><a href="http://www.ms509.com/?attachment_id=430" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/6.jpg" alt="6"></a> <a href="http://www.ms509.com/?attachment_id=431" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/7.jpg" alt="7"></a> <a href="http://www.ms509.com/?attachment_id=432" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/8.jpg" alt="8"></a></p>
<p>如上，木马自己的远控命令一共有13个，最重要的两个就是<strong>eval命令</strong>：执行php代码；<strong>cmd命令</strong>：执行shell命令行</p>
<p>所有命令和功能如下：</p>
<pre class="lang:default decode:true ">reload：退出后重连

safe：获取php的安全模式信息

conback：未实现

dns：域名查询

info：未实现

vuln：获取服务器信息

bot：获取web shell类型

uname：获取PHP系统相关信息

rndnick：设置随机昵称

raw：原始消息发送

eval：执行php代码

cmd：执行shell代码

mati：断开连接</pre>
<p>到此，通过一个简单的IRC聊天客户端，连接IRC服务器：irc.mildnet.net；进入预先设置好的私有频道：#ccpower，#siantar（频道密码：correct），就可以像聊QQ一样，和群里的肉鸡”聊天“了，聊天的内容就是上面的13个命令</p>
<h3 id="二、mil-php"><a href="#二、mil-php" class="headerlink" title="二、mil.php"></a><strong>二、mil.php</strong></h3><p>压缩包里还有另外一个php文件，这个不是IRC木马，解码后也简单的分析下：</p>
<p>mil.php木马有两个功能</p>
<pre class="lang:default decode:true">1）执行shell命令

2）上传文件</pre>
<p><a href="http://www.ms509.com/?attachment_id=508" target="_blank" rel="noopener">
</a><a href="http://www.ms509.com/?attachment_id=510" target="_blank" rel="noopener"><img src="http://www.ms509.com/wp-content/uploads/2016/08/shangchuan.png" alt="shangchuan"></a></p>
<p>上面两个form表单是木马的操作界面，这样看不是太清楚，把两个form字符串保存成html文件，用浏览器里打开看就比较清楚了</p>
<p><img src="http://www.ms509.com/wp-content/uploads/2016/08/xuanze.png" alt="xuanze"></p>
<p>从上面的界面文字以及php里的一些字符串发现不是英文，感觉有点像马来文。由于文字很少，也没进一步考证</p>
<p><img src="http://www.ms509.com/wp-content/uploads/2016/08/htaccess.png" alt="htaccess"></p>
<p>最后是增加.htaccess配置文件，文件内容又经过了编码处理，估计是配置网马文件的权限，解码后证实一下</p>
<p><img src="http://www.ms509.com/wp-content/uploads/2016/08/PHP.png" alt="PHP"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div><div class="tags"><a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/"><i class="fa fa-tag"></i>恶意程序</a></div><div class="post-nav"><a class="pre" href="/2016/09/30/android-cve2015-3825exp/">Android漏洞CVE-2015-3825分析及exploit实战：从Crash到劫持PC</a><a class="next" href="/2016/07/26/ghost-virus/">分析重装系统也无法清除的鬼影病毒</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/" style="font-size: 15px;">登陆凭证</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 15px;">内网穿透</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%8E%9F%E5%88%9B%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">原创漏洞</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a> <a href="/tags/WAF%E7%BB%95%E8%BF%87/" style="font-size: 15px;">WAF绕过</a> <a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">杀毒软件</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/Cknife/" style="font-size: 15px;">Cknife</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">审计工具</a> <a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">恶意程序</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/24/Waf-Bypass-Sql/">WAF绕过奇技淫巧之SQL注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Collect-login-credentials/">linux后渗透之收集登录凭证</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/Subrion-Cms-Code-Audit/">Subrion CMS 代码审计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/19/Java-Debug/">Java无源码调试之英雄崛起</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-smep-bypass/">CVE-2017-8890实现linux内核提权- SMEP绕过</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-kernel-escalation1/">利用CVE-2017-8890实现linux内核提权- ret2usr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/03/bundle-mismatch/">Bundle风水——Android序列化与反序列化不匹配漏洞详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/03/qwb2-silent-writeup/">强网杯silent分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>