<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功） | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/contact/"><i class="fa fa-comments"> 联系</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</h1><div class="post-meta">2017-06-06<span> | </span><span class="category"><a href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>作者：expsky</p>
<p><strong>360公司针对此文发出回应：</strong></p>
<blockquote>
<p>360安全卫士能够防御“模拟用户退出安全软件”的攻击方法，本文的演示应该是在64位系统关闭了360“核晶引擎”的情况下进行的。</p>
<p>由于64位系统的限制，安全软件需要应用CPU硬件虚拟化技术才能具备完整的防护能力，否则任何安全软件都可以被轻易关闭。核晶引擎是360在国内首家针对64位系统推出的CPU硬件虚拟化防护引擎，在开启了64位系统默认打开的“核晶引擎”后，360能够防御本文描述的攻击方法，读者可以自行验证。</p>
</blockquote>
<a id="more"></a>

<p>木马与杀软的对抗从未停止，这样的对抗客观上也促进了安全技术的进步与发展。病毒、木马除了本身的功能以外，最重要一部分就是与杀软的对抗，这也是技术难点所在。试想一下如果在一台没装杀软的电脑上，病毒木马不需要什么注入、白加黑、rootkit技术来隐藏进程，不需要用什么高深未公开的方式来实现自启动，不需要精心构造隐秘通道实现C&amp;C通信，不需要加密混淆来躲避静态查杀，也不用担心调用了跨进程内存读写或者注册表敏感位置读写、磁盘扇区读写、驱动加载等被杀软主防列为的危险API…….只需一个十多年前的简单木马就可以为所欲为。</p>
<p><strong>关闭杀软，是病毒木马追求的最理想状态，但能做到这点只有极少数的特种木马或rootkit型木马能办到，绝大部分木马也只是通过各种技术手段来绕过杀软的部分功能，少有听说能关掉杀软的木马。</strong></p>
<p><strong>真有能关掉杀软的技术手段吗？</strong></p>
<h3 id="0x01-原理思路"><a href="#0x01-原理思路" class="headerlink" title="0x01 原理思路"></a><strong>0x01</strong> 原理思路</h3><p>我们尝试用模拟真实用户的操作，来关闭杀软。这里用360安全卫士目前最新版作为实验对象。是否能成功，我们一起往下看。</p>
<p>（声明：本人并不刻意针对360，而正是认可360在国内安全行业具有的代表性，并且该技术思路可以适用于其余绝大部分杀软）</p>
<p>要模拟真实用户关闭360安全卫士的流程如下：</p>
<p><strong>1）鼠标右键点击桌面右下角360卫士的系统托盘图标</strong></p>
<p><strong>2）在弹出的托盘菜单中点击【退出】按钮</strong></p>
<p><img src="/2017/06/06/bypass360-analysis/1.jpg" alt="1"></p>
<p><strong>3）在弹出的360卫士退出窗口中点击【继续退出】按钮</strong></p>
<p><img src="/2017/06/06/bypass360-analysis/2.jpg" alt="2"></p>
<p>完成以上步骤后360安全卫士就会被关闭。</p>
<p>接下来就是如何用程序自动模拟完成这些动作。</p>
<h3 id="0x02-技术实现"><a href="#0x02-技术实现" class="headerlink" title="0x02** 技术实现**"></a>0x02** 技术实现**</h3><p>点击相关窗口的按钮是通过对应的窗口类名得到相应的窗口句柄，然后实现点击。</p>
<p>通过“<strong>彗星小助手</strong>”的<strong>窗口SPY</strong>功能可以找出需要的窗口类名，而通过窗口类名找出窗口句柄是常规windows编程的知识，本文就不再累述</p>
<p><img src="/2017/06/06/bypass360-analysis/3.jpg" alt="3"></p>
<p>这里需要注意的是，系统360卫士托盘图标可能直接显示在桌面右下角的系统托盘上，也可能在隐藏的系统托盘区域。两种情况都需要考虑到</p>
<p><strong>系统托盘的窗口类</strong></p>
<p><img src="http://image.3001.net/images/20170524/14956090698671.jpg" alt></p>
<p><strong>Shell_TrayWnd   &gt;&gt;   TrayNotifyWnd   &gt;&gt;   ToolbarWindow32</strong> 通过这样的窗口关系找出系统托盘</p>
<p><img src="http://image.3001.net/images/20170524/14956093095715.jpg" alt></p>
<p>而隐藏区域的系统托盘窗口类名是<strong>NotifyIconOverflowWindow</strong></p>
<p><img src="http://image.3001.net/images/20170524/14956095431444.jpg" alt></p>
<p>360卫士托盘菜单窗口类名：<strong>Q360TrayMenuClass</strong></p>
<p>360卫士退出窗口类名：<strong>Q360HIPSClass</strong></p>
<p>到此就可以定位到所有需要的窗口，我们还需要定位到窗口上的两个【退出】按钮</p>
<p><img src="http://image.3001.net/images/20170524/14956100122566.jpg!small" alt="7.jpg">)<img src="http://image.3001.net/images/20170524/14956100122271.jpg!small" alt="8.jpg"></p>
<p>这里需要注意的是，按钮实际上也是一个子窗口，普通的windows按钮通过<strong>彗星小助手</strong>可以直接定位识别，但现在很多软件包括这里的360卫士，按钮都是自绘出来的，不是传统的按钮控件，不能直接识别。不过也有办法，因为【退出】按钮相对于父窗口的位置是固定，通过父窗口的位置与【退出】按钮的相对位置<strong>，</strong>就可以分别定位到两个需要点击的【退出】按钮，模拟鼠标点击就可以自动关闭360安全卫士</p>
<p>定位360卫士托盘菜单的【退出】按钮位置：<img src="http://image.3001.net/images/20170524/14956100122566.jpg!small" alt="7.jpg"></p>
<blockquote>
<p>x坐标 = 托盘菜单的x坐标 + 托盘菜单的宽度（260）- 20</p>
<p>y坐标 = 托盘菜单的y坐标 + 托盘菜单的高度（560）- 10</p>
<p>说明：-20和-10 即为【退出】按钮相对窗口右下角的位置<br>定位360卫士退出窗口上的【继续退出】按钮位置：<img src="http://image.3001.net/images/20170524/14956100122271.jpg!small" alt="8.jpg"><br>x坐标 = 360退出窗口x坐标 + 360退出窗口的宽度（600）- 120</p>
<p>y坐标 = 360退出窗口y坐标 + 360退出窗口的高度（400）- 40</p>
<p>说明：-120和-40 即为【继续退出】按钮相对窗口右下角的位置</p>
</blockquote>
<h3 id="0x03-真实演示"><a href="#0x03-真实演示" class="headerlink" title="0x03 真实演示"></a>0x03 真实演示</h3><p>“空谈误国，实干兴邦”，理论讲得再好，实现不了还是等于零。所以按照上面的技术思路我实现了一个演示工具，成功关闭了360卫士。大概1秒钟左右360安全卫士就被关闭了。录制了一张gif动图展示了整个过程</p>
<p><img src="http://image.3001.net/images/20170525/14957088543120.gif!small" alt="demo.gif"></p>
<p>从上面的动图可以看出，关闭过程中会有窗口闪动。因为实现原理本来就是模拟用户的实际操作，所以用户真实关闭360卫士会出现的窗口这里都会出现。</p>
<p>有人可能会质疑这样不是就被用户发现了吗，其实这已经不重要了，木马已经在没有防护的环境下植入用户电脑，相关恶意代码已经成功执行。</p>
<h3 id="0x04-结尾"><a href="#0x04-结尾" class="headerlink" title="0x04 结尾"></a><strong>0x04</strong> 结尾</h3><p>如何防御这种攻击手段，通常的做法是在关闭安全软件的时候要求输入验证码，确保是人的真实操作，但验证码这种方式会影响用户使用体验，也不是最佳的方案。要想找到一个特别理想的方案不是太容易，做安全很多时候都是不得不去牺牲一些其他代价</p>
<p>由于本演示程序具有危害，所以这里就不提供源码了，但本文已经把这个原理以及相关的窗口类名称等重要信息说的很清楚，熟悉windows编程的话很容易自己就可以实现。唯一还有一个小点需要注意的是在系统托盘里如何定位到360卫士图标的位置，我是通过图像识别的方法来实现的，也许还有其他更好的办法。</p>
<p>本文的目的不是宣扬去攻击安全软件，而是想说明攻防的博弈永远没有尽头，而攻击者对安全技术研究的深度、广度、还有脑洞的大小，都会使得各种新型攻击方式出现，安全从业人员不能放松警惕。</p>
</div><div class="tags"><a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/"><i class="fa fa-tag"></i>杀毒软件</a></div><div class="post-nav"><a class="pre" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a><a class="next" href="/2017/05/14/wannacry/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">逆向分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/" style="font-size: 15px;">登陆凭证</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 15px;">内网穿透</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%8E%9F%E5%88%9B%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">原创漏洞</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">杀毒软件</a> <a href="/tags/Cknife/" style="font-size: 15px;">Cknife</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">审计工具</a> <a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">恶意程序</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Collect-login-credentials/">linux后渗透之收集登录凭证</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/Subrion-Cms-Code-Audit/">Subrion CMS 代码审计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/19/Java-Debug/">Java无源码调试之英雄崛起</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-smep-bypass/">CVE-2017-8890实现linux内核提权- SMEP绕过</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-kernel-escalation1/">利用CVE-2017-8890实现linux内核提权- ret2usr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/03/bundle-mismatch/">Bundle风水——Android序列化与反序列化不匹配漏洞详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/03/qwb2-silent-writeup/">强网杯silent分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/22/android-blueborne2/">Android蓝牙远程命令执行漏洞利用实践 exploit优化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>